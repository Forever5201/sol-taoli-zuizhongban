# äºŒæ¬¡éªŒè¯é€šè¿‡æœºä¼š - å¾®ä¿¡æ¨é€å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚åˆ†æ

**ç›®æ ‡**ï¼šå½“å¥—åˆ©æœºä¼šé€šè¿‡äºŒæ¬¡éªŒè¯åï¼Œç«‹å³æ¨é€åˆ°å¾®ä¿¡ï¼ŒåŒ…å«è¯¦ç»†çš„éªŒè¯æ•°æ®å’Œå»¶è¿Ÿä¿¡æ¯ã€‚

**æ¨é€æ—¶æœº**ï¼š
- âœ… Workerå‘ç°æœºä¼šï¼ˆç¬¬ä¸€æ¬¡ï¼‰
- âœ… **äºŒæ¬¡éªŒè¯é€šè¿‡**ï¼ˆæ–°å¢ï¼‰â† æ‚¨è¦çš„åŠŸèƒ½
- âœ… RPCæ¨¡æ‹Ÿé€šè¿‡
- âœ… äº¤æ˜“æ‰§è¡ŒæˆåŠŸ

---

## ğŸ” ç°æœ‰ç³»ç»Ÿåˆ†æ

### 1. ServerChanå¾®ä¿¡æ¨é€
- **æ–‡ä»¶**: `packages/core/src/monitoring/serverchan-adapter.ts`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: æ”¯æŒå‘é€æ ¼å¼åŒ–æ¶ˆæ¯åˆ°å¾®ä¿¡

### 2. ç›‘æ§æœåŠ¡
- **æ–‡ä»¶**: `packages/core/src/monitoring/service.ts`
- **å·²æœ‰æ–¹æ³•**:
  - `alertOpportunityFound()` - å‘ç°æœºä¼šæ—¶é€šçŸ¥
  - `alertProfit()` - äº¤æ˜“æˆåŠŸæ—¶é€šçŸ¥
  - `alertError()` - é”™è¯¯æ—¶é€šçŸ¥
  - `alertWarning()` - è­¦å‘Šæ—¶é€šçŸ¥

### 3. äºŒæ¬¡éªŒè¯æµç¨‹
- **æ–‡ä»¶**: `packages/jupiter-bot/src/flashloan-bot.ts`
- **æ–¹æ³•**: `handleOpportunity()`
- **æµç¨‹**:
  ```
  å‘ç°æœºä¼š â†’ è®°å½•æ•°æ®åº“ â†’ äºŒæ¬¡éªŒè¯ â†’ éªŒè¯é€šè¿‡ â†’ ç»§ç»­æ‰§è¡Œ
                                    â†“
                                  è¿™é‡Œéœ€è¦æ¨é€ï¼
  ```

---

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ‰©å±•ç›‘æ§æœåŠ¡æ¥å£

**æ–‡ä»¶**: `packages/core/src/monitoring/service.ts`

#### 1.1 æ·»åŠ é…ç½®é€‰é¡¹
```typescript
export interface MonitoringServiceConfig {
  // ... ç°æœ‰é…ç½® ...
  
  /** æ˜¯å¦åœ¨äºŒæ¬¡éªŒè¯é€šè¿‡æ—¶å‘Šè­¦ */
  alertOnOpportunityValidated?: boolean;
  /** æœ€å°éªŒè¯é€šè¿‡åˆ©æ¶¦å‘Šè­¦é˜ˆå€¼ï¼ˆlamportsï¼‰ */
  minValidatedProfitForAlert?: number;
  /** éªŒè¯é€šè¿‡å‘Šè­¦é¢‘ç‡é™åˆ¶ï¼ˆæ¯«ç§’ï¼‰ */
  validatedAlertRateLimitMs?: number;
}
```

#### 1.2 æ·»åŠ æ–°æ–¹æ³•
```typescript
/**
 * å¥—åˆ©æœºä¼šäºŒæ¬¡éªŒè¯é€šè¿‡é€šçŸ¥
 */
async alertOpportunityValidated(
  opportunity: {
    inputMint: string;
    bridgeToken?: string;
    // ç¬¬ä¸€æ¬¡æ£€æµ‹æ•°æ®
    firstProfit: number;
    firstRoi: number;
    firstOutboundMs?: number;
    firstReturnMs?: number;
    // ç¬¬äºŒæ¬¡éªŒè¯æ•°æ®
    secondProfit: number;
    secondRoi: number;
    secondOutboundMs?: number;
    secondReturnMs?: number;
    // éªŒè¯å»¶è¿Ÿ
    validationDelayMs: number;
  }
): Promise<boolean> {
  if (!this.config.alertOnOpportunityValidated) {
    return false;
  }
  
  if (opportunity.secondProfit < this.config.minValidatedProfitForAlert) {
    return false;
  }

  // é¢‘ç‡é™åˆ¶
  if (this.config.validatedAlertRateLimitMs > 0) {
    const now = Date.now();
    if (now - this.lastAlertTime < this.config.validatedAlertRateLimitMs) {
      return false;
    }
  }

  const firstProfitSOL = (opportunity.firstProfit / 1_000_000_000).toFixed(6);
  const secondProfitSOL = (opportunity.secondProfit / 1_000_000_000).toFixed(6);
  const profitChange = ((opportunity.secondProfit - opportunity.firstProfit) / opportunity.firstProfit * 100).toFixed(2);
  
  const fields: Array<{ name: string; value: string; inline: boolean }> = [
    { name: 'ğŸ¯ éªŒè¯çŠ¶æ€', value: 'âœ… é€šè¿‡äºŒæ¬¡éªŒè¯', inline: false },
    { name: '', value: '---', inline: false },
    
    // åˆ©æ¶¦å¯¹æ¯”
    { name: 'ğŸ’° é¦–æ¬¡åˆ©æ¶¦', value: `${firstProfitSOL} SOL (${(opportunity.firstRoi * 100).toFixed(2)}%)`, inline: true },
    { name: 'ğŸ’ éªŒè¯åˆ©æ¶¦', value: `${secondProfitSOL} SOL (${(opportunity.secondRoi * 100).toFixed(2)}%)`, inline: true },
    { name: 'ğŸ“Š åˆ©æ¶¦å˜åŒ–', value: `${profitChange}%`, inline: true },
    { name: '', value: '', inline: false },
    
    // å»¶è¿Ÿåˆ†æ
    { name: 'â±ï¸ éªŒè¯å»¶è¿Ÿ', value: `${opportunity.validationDelayMs}ms`, inline: true },
    { name: 'ğŸ”„ é¦–æ¬¡æŸ¥è¯¢', value: `${opportunity.firstOutboundMs || 'N/A'}ms + ${opportunity.firstReturnMs || 'N/A'}ms`, inline: true },
    { name: 'ğŸ” éªŒè¯æŸ¥è¯¢', value: `${opportunity.secondOutboundMs || 'N/A'}ms + ${opportunity.secondReturnMs || 'N/A'}ms`, inline: true },
    { name: '', value: '', inline: false },
    
    // è·¯å¾„ä¿¡æ¯
    { name: 'ğŸ”€ äº¤æ˜“è·¯å¾„', value: opportunity.bridgeToken 
      ? `SOL â†’ ${opportunity.bridgeToken} â†’ SOL` 
      : 'SOL â†’ ? â†’ SOL', inline: false },
  ];

  return await this.alert({
    type: 'info',
    level: 'medium',
    title: 'âœ… æœºä¼šé€šè¿‡äºŒæ¬¡éªŒè¯',
    description: `å‘ç°é«˜è´¨é‡å¥—åˆ©æœºä¼šï¼Œå·²é€šè¿‡äºŒæ¬¡éªŒè¯ï¼Œåˆ©æ¶¦ ${secondProfitSOL} SOL`,
    fields,
  });
}
```

---

### æ­¥éª¤2ï¼šåœ¨Botä¸­è°ƒç”¨æ¨é€

**æ–‡ä»¶**: `packages/jupiter-bot/src/flashloan-bot.ts`

**ä½ç½®**: `handleOpportunity()` æ–¹æ³•ä¸­ï¼ŒäºŒæ¬¡éªŒè¯é€šè¿‡å

```typescript
// âœ… æ–°å¢ï¼šç«‹å³äºŒæ¬¡éªŒè¯
logger.info('ğŸ”„ Performing immediate re-validation...');
const revalidation = await this.validateOpportunityLifetime(opportunity);

logger.info(
  `ğŸ“Š Validation result: ` +
  `stillExists=${revalidation.stillExists}, ` +
  `profit=${(revalidation.secondProfit / LAMPORTS_PER_SOL).toFixed(6)} SOL ` +
  `(${(revalidation.secondRoi * 100).toFixed(2)}%), ` +
  `delay=${revalidation.delayMs}ms`
);

// âœ… æ–°å¢ï¼šè®°å½•éªŒè¯ç»“æœï¼ˆåŒ…å«è¯¦ç»†å»¶è¿Ÿæ•°æ®ï¼‰
if (this.config.database?.enabled && opportunityId) {
  // ... æ•°æ®åº“è®°å½• ...
}

// âœ… æ–°å¢ï¼šå¦‚æœæœºä¼šå·²æ¶ˆå¤±ï¼Œè®°å½•å¹¶é€€å‡º
if (!revalidation.stillExists) {
  logger.warn(`â±ï¸ Opportunity expired after ${revalidation.delayMs}ms, skipping execution`);
  // ... æ ‡è®°ä¸ºè¿‡æ»¤ ...
  return;
}

// ğŸ”¥ æ–°å¢ï¼šäºŒæ¬¡éªŒè¯é€šè¿‡ï¼Œæ¨é€å¾®ä¿¡é€šçŸ¥
if (this.monitoring) {
  await this.monitoring.alertOpportunityValidated({
    inputMint: opportunity.inputMint.toBase58(),
    bridgeToken: opportunity.bridgeToken,
    // ç¬¬ä¸€æ¬¡æ•°æ®
    firstProfit: opportunity.profit,
    firstRoi: opportunity.roi,
    firstOutboundMs: opportunity.latency?.outboundMs,
    firstReturnMs: opportunity.latency?.returnMs,
    // ç¬¬äºŒæ¬¡æ•°æ®
    secondProfit: revalidation.secondProfit,
    secondRoi: revalidation.secondRoi,
    secondOutboundMs: revalidation.secondOutboundMs,
    secondReturnMs: revalidation.secondReturnMs,
    // éªŒè¯å»¶è¿Ÿ
    validationDelayMs: revalidation.delayMs,
  });
}

// ç»§ç»­æ‰§è¡Œåç»­æµç¨‹ï¼ˆRPCæ¨¡æ‹Ÿã€äº¤æ˜“æ„å»ºç­‰ï¼‰
// ...
```

---

### æ­¥éª¤3ï¼šé…ç½®æ–‡ä»¶æ›´æ–°

**æ–‡ä»¶**: `configs/flashloan-dryrun.toml`

#### æ·»åŠ é…ç½®é¡¹
```toml
# ===================================================================
# ç›‘æ§é…ç½® - å¾®ä¿¡æ¨é€
# ===================================================================
[monitoring]
enabled = true  # å¯ç”¨ç›‘æ§

[monitoring.serverchan]
send_key = "YOUR_SENDKEY_HERE"  # æ‚¨çš„ SendKey
enabled = true

# é€šçŸ¥è®¾ç½®
alert_on_profit = true  # äº¤æ˜“æˆåŠŸæ—¶é€šçŸ¥
alert_on_error = true  # å‡ºé”™æ—¶é€šçŸ¥
alert_on_warning = true  # è­¦å‘Šæ—¶é€šçŸ¥

# æœºä¼šå‘ç°é€šçŸ¥ï¼ˆç¬¬ä¸€æ¬¡å‘ç°ï¼‰
alert_on_opportunity_found = false  # å…³é—­é¦–æ¬¡å‘ç°é€šçŸ¥ï¼ˆé¿å…åˆ·å±ï¼‰
min_opportunity_profit_for_alert = 2_000_000  # 0.002 SOL

# ğŸ”¥ æ–°å¢ï¼šäºŒæ¬¡éªŒè¯é€šè¿‡é€šçŸ¥
alert_on_opportunity_validated = true  # å¯ç”¨äºŒæ¬¡éªŒè¯é€šçŸ¥
min_validated_profit_for_alert = 2_000_000  # æœ€å°åˆ©æ¶¦ 0.002 SOL
validated_alert_rate_limit_ms = 0  # 0 = ä¸é™åˆ¶é¢‘ç‡ï¼ˆæ¯ä¸ªæœºä¼šéƒ½æ¨é€ï¼‰

# é™æµè®¾ç½®ï¼ˆé’ˆå¯¹æ‰€æœ‰é€šçŸ¥ï¼‰
rate_limit_ms = 3000  # 3ç§’å†…æœ€å¤šå‘é€1æ¡
max_batch_size = 5  # æœ€å¤§æ‰¹é‡5æ¡
```

---

## ğŸ“± æ¨é€æ¶ˆæ¯ç¤ºä¾‹

### å¾®ä¿¡æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ ¼å¼

**æ ‡é¢˜**: âœ… æœºä¼šé€šè¿‡äºŒæ¬¡éªŒè¯

**å†…å®¹**:
```
å‘ç°é«˜è´¨é‡å¥—åˆ©æœºä¼šï¼Œå·²é€šè¿‡äºŒæ¬¡éªŒè¯ï¼Œåˆ©æ¶¦ 0.003215 SOL

---

ğŸ¯ éªŒè¯çŠ¶æ€: âœ… é€šè¿‡äºŒæ¬¡éªŒè¯

---

ğŸ’° é¦–æ¬¡åˆ©æ¶¦: 0.003500 SOL (0.35%)
ğŸ’ éªŒè¯åˆ©æ¶¦: 0.003215 SOL (0.32%)
ğŸ“Š åˆ©æ¶¦å˜åŒ–: -8.14%

â±ï¸ éªŒè¯å»¶è¿Ÿ: 245ms
ğŸ”„ é¦–æ¬¡æŸ¥è¯¢: 198ms + 187ms
ğŸ” éªŒè¯æŸ¥è¯¢: 165ms + 152ms

ğŸ”€ äº¤æ˜“è·¯å¾„: SOL â†’ USDC â†’ SOL

---

**æ—¶é—´**: 2025-10-23 17:35:42
**çº§åˆ«**: ğŸŸ¡ ä¸­
```

---

## âœ… ä¼˜åŠ¿åˆ†æ

### ä¸ºä»€ä¹ˆåœ¨äºŒæ¬¡éªŒè¯åæ¨é€ï¼Ÿ

1. **è´¨é‡æ›´é«˜** â­â­â­â­â­
   - åªæ¨é€çœŸæ­£æœ‰æ•ˆçš„æœºä¼š
   - è¿‡æ»¤æ‰ç¬é—´æ¶ˆå¤±çš„æœºä¼š
   - é¿å…å‡é˜³æ€§ï¼ˆAPIæ•°æ®é”™è¯¯ï¼‰

2. **ä¿¡æ¯æ›´å®Œæ•´** â­â­â­â­â­
   - å¯¹æ¯”é¦–æ¬¡å’ŒéªŒè¯çš„åˆ©æ¶¦
   - æ˜¾ç¤ºå»¶è¿Ÿå’Œä»·æ ¼å˜åŒ–
   - è¯„ä¼°æœºä¼šç¨³å®šæ€§

3. **å‡å°‘åˆ·å±** â­â­â­â­
   - ç¬¬ä¸€æ¬¡å‘ç°å¯èƒ½æœ‰å¾ˆå¤š
   - äºŒæ¬¡éªŒè¯é€šè¿‡çš„å°‘å¾—å¤š
   - åªæ¨é€çœŸæ­£å€¼å¾—å…³æ³¨çš„

4. **ä¾¿äºå†³ç­–** â­â­â­â­â­
   - çœ‹åˆ°æ¨é€æ—¶ï¼Œæœºä¼šä»ç„¶æœ‰æ•ˆ
   - æœ‰è¶³å¤Ÿæ•°æ®åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ
   - å¯ä»¥æ‰‹åŠ¨ä»‹å…¥ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰

---

## ğŸ”§ å¯é€‰ä¼˜åŒ–

### ä¼˜åŒ–1ï¼šæ™ºèƒ½é™æµï¼ˆæ¨èï¼‰

å¦‚æœæœºä¼šå¤ªå¤šå¯¼è‡´åˆ·å±ï¼Œå¯ä»¥ï¼š

```toml
# æ™ºèƒ½é™æµç­–ç•¥
validated_alert_rate_limit_ms = 30000  # 30ç§’å†…æœ€å¤š1æ¡
min_validated_profit_for_alert = 5_000_000  # æé«˜åˆ° 0.005 SOL

# æˆ–è€…åªæ¨é€"ç‰¹åˆ«å¥½"çš„æœºä¼š
[monitoring.priority_alerts]
enabled = true
high_priority_profit_threshold = 10_000_000  # 0.01 SOL
high_priority_alerts_bypass_rate_limit = true  # é«˜åˆ©æ¶¦æœºä¼šç»•è¿‡é™æµ
```

### ä¼˜åŒ–2ï¼šåˆ†çº§æ¨é€

```typescript
// æ ¹æ®åˆ©æ¶¦åˆ†çº§
if (secondProfit >= 10_000_000) {
  // ğŸ”´ é«˜ä»·å€¼æœºä¼šï¼ˆ>= 0.01 SOLï¼‰
  title = 'ğŸ”¥ é«˜ä»·å€¼æœºä¼šé€šè¿‡éªŒè¯';
  level = 'high';
} else if (secondProfit >= 5_000_000) {
  // ğŸŸ¡ ä¸­ä»·å€¼æœºä¼šï¼ˆ>= 0.005 SOLï¼‰
  title = 'âœ… æœºä¼šé€šè¿‡äºŒæ¬¡éªŒè¯';
  level = 'medium';
} else {
  // ğŸŸ¢ ä½ä»·å€¼æœºä¼šï¼ˆ< 0.005 SOLï¼‰
  title = 'â„¹ï¸ å°é¢æœºä¼šé€šè¿‡éªŒè¯';
  level = 'low';
}
```

### ä¼˜åŒ–3ï¼šæ·»åŠ å¿«æ·é“¾æ¥

```typescript
fields.push({
  name: 'ğŸ“Š è¯¦ç»†åˆ†æ',
  value: `æŸ¥çœ‹æ•°æ®åº“è®°å½• ID: ${opportunityId}`,
  inline: false,
});

fields.push({
  name: 'ğŸ”— å¿«æ·æ“ä½œ',
  value: `[æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…](http://your-dashboard.com/opportunities/${opportunityId})`,
  inline: false,
});
```

---

## ğŸ“Š æ•ˆæœé¢„ä¼°

åŸºäºæ‚¨å½“å‰çš„é…ç½®ï¼ˆ4 workersï¼Œ3ç§’é—´éš”ï¼Œ2M lamportsé˜ˆå€¼ï¼‰ï¼š

| æŒ‡æ ‡ | é¢„ä¼°å€¼ | è¯´æ˜ |
|------|--------|------|
| é¦–æ¬¡å‘ç° | ~20-30æ¬¡/å°æ—¶ | Workerå‘ç°è¶…è¿‡é˜ˆå€¼çš„æœºä¼š |
| äºŒæ¬¡éªŒè¯é€šè¿‡ | ~5-10æ¬¡/å°æ—¶ | çº¦30-50%çš„æœºä¼šä»ç„¶æœ‰æ•ˆ |
| å¾®ä¿¡æ¨é€æ•°é‡ | 5-10æ¬¡/å°æ—¶ | åªæ¨é€éªŒè¯é€šè¿‡çš„ |
| åˆ·å±é£é™© | ä½ | å¹³å‡6-12åˆ†é’Ÿ1æ¡ |

**ç»“è®º**ï¼šæ¨é€é¢‘ç‡åˆç†ï¼Œä¸ä¼šåˆ·å± âœ…

---

## ğŸš€ å®æ–½æ—¶é—´è¡¨

1. **æ­¥éª¤1**ï¼šæ‰©å±•ç›‘æ§æœåŠ¡ - 10åˆ†é’Ÿ
2. **æ­¥éª¤2**ï¼šBoté›†æˆæ¨é€ - 5åˆ†é’Ÿ
3. **æ­¥éª¤3**ï¼šé…ç½®æ–‡ä»¶æ›´æ–° - 3åˆ†é’Ÿ
4. **æ­¥éª¤4**ï¼šæµ‹è¯•éªŒè¯ - 5åˆ†é’Ÿ

**æ€»è®¡**ï¼šçº¦ 20-25åˆ†é’Ÿ

---

## ğŸ“ æµ‹è¯•æ¸…å•

- [ ] ç¼–è¯‘æ— é”™è¯¯
- [ ] é…ç½®å·²æ›´æ–°ï¼ˆSendKeyæ­£ç¡®ï¼‰
- [ ] Botå¯åŠ¨æˆåŠŸ
- [ ] å‘ç°æœºä¼šæ—¶æ— æ¨é€ï¼ˆ`alert_on_opportunity_found = false`ï¼‰
- [ ] äºŒæ¬¡éªŒè¯é€šè¿‡æ—¶æœ‰æ¨é€
- [ ] æ¨é€å†…å®¹åŒ…å«æ‰€æœ‰å­—æ®µ
- [ ] å»¶è¿Ÿæ•°æ®æ­£ç¡®æ˜¾ç¤º
- [ ] é¢‘ç‡é™åˆ¶ç”Ÿæ•ˆ

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿè¯·å‘Šè¯‰æˆ‘"å¼€å§‹å®æ–½"ï¼Œæˆ‘ä¼šç«‹å³ä¸ºæ‚¨å®ç°ï¼** ğŸš€

