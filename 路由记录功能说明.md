# ğŸ›£ï¸ è·¯ç”±è®°å½•åŠŸèƒ½è¯´æ˜æ–‡æ¡£

## âœ… åŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿç°åœ¨å¯ä»¥**è‡ªåŠ¨è®°å½•æ¯ä¸ªå¥—åˆ©æœºä¼šçš„å®Œæ•´è·¯ç”±è·¯å¾„**åˆ°æ•°æ®åº“ï¼Œç”¨äºåç»­åˆ†æå’Œä¼˜åŒ–ã€‚

---

## ğŸ“Š è®°å½•çš„è·¯ç”±ä¿¡æ¯

### 1ï¸âƒ£ å­˜å‚¨ä½ç½®

è·¯ç”±ä¿¡æ¯å­˜å‚¨åœ¨ `opportunities` è¡¨çš„ `metadata` å­—æ®µä¸­ï¼ˆJSON æ ¼å¼ï¼‰

### 2ï¸âƒ£ æ•°æ®ç»“æ„

```json
{
  "routeInfo": {
    "hasRouteData": true,
    "outboundRoute": [
      {
        "stepNumber": 1,
        "direction": "outbound",
        "dex": "Orca",
        "inputMint": "So11111111...",
        "outputMint": "EPjFWdd5Au...",
        "inputAmount": "10000000000",
        "outputAmount": "1894295485"
      }
    ],
    "returnRoute": [
      {
        "stepNumber": 2,
        "direction": "return",
        "dex": "Raydium",
        "inputMint": "EPjFWdd5Au...",
        "outputMint": "So11111111...",
        "inputAmount": "1894295485",
        "outputAmount": "10002375322"
      }
    ],
    "totalHops": 2,
    "dexes": ["Orca", "Raydium"]
  },
  "bridgeInfo": {
    "symbol": "USDC",
    "mint": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
    "amount": "1894295485"
  },
  "profitAnalysis": {
    "expectedProfit": 2375322,
    "roi": 0.0002375322,
    "inputAmount": 10000000000,
    "outputAmount": 10002375322
  },
  "queryInfo": {
    "queryTime": 493,
    "timestamp": "2025-10-23T14:25:56.210Z"
  }
}
```

---

## ğŸ”¬ å¦‚ä½•æŸ¥çœ‹è·¯ç”±æ•°æ®

### æ–¹æ³• 1: ä½¿ç”¨åˆ†æè„šæœ¬ï¼ˆæ¨èï¼‰â­

```bash
# è¿è¡Œè·¯ç”±åˆ†æè„šæœ¬
pnpm tsx analyze-routes.ts
```

**è¾“å‡ºç¤ºä¾‹**:
```
ğŸ” æ­£åœ¨åˆ†æè·¯ç”±æ•°æ®...

ğŸ“Š æ‰¾åˆ° 2 æ¡åŒ…å«å…ƒæ•°æ®çš„æœºä¼šè®°å½•

1. [filtered] 2025-10-23 22:25:56
   ID: 1
   æ¡¥æ¥ä»£å¸: USDT
   åˆ©æ¶¦: 0.002375 SOL (0.0237%)
   æ€»è·³æ•°: 2
   å»ç¨‹è·¯ç”± (1 æ­¥):
     Step 1: Orca
       So111111... â†’ Es9vMFrz...
   è¿”ç¨‹è·¯ç”± (1 æ­¥):
     Step 2: Raydium
       Es9vMFrz... â†’ So111111...
   ä½¿ç”¨çš„ DEX: Orca, Raydium

================================================================================
ğŸ“Š è·¯ç”±ç»Ÿè®¡æ±‡æ€»
================================================================================

âœ… åŒ…å«è·¯ç”±æ•°æ®çš„æœºä¼š: 2 æ¡
âŒ ä¸åŒ…å«è·¯ç”±æ•°æ®çš„æœºä¼š: 0 æ¡

ğŸ“Š è·³æ•°åˆ†å¸ƒ:
   2 è·³: 2 æ¡ (100.0%)

ğŸ’° æŒ‰è·³æ•°çš„å¹³å‡åˆ©æ¶¦:
   2 è·³: å¹³å‡ 0.002307 SOL (2 æ¡)

ğŸ¦ DEX ä½¿ç”¨ç»Ÿè®¡:
   Orca: 2 æ¬¡ (100.0%)
   Raydium: 2 æ¬¡ (100.0%)
```

### æ–¹æ³• 2: ç›´æ¥æŸ¥è¯¢æ•°æ®åº“

```sql
-- æŸ¥è¯¢æœ€è¿‘çš„æœºä¼šåŠå…¶è·¯ç”±ä¿¡æ¯
SELECT 
  id,
  first_detected_at,
  first_profit / 1e9 as profit_sol,
  bridge_token,
  metadata->'routeInfo'->>'totalHops' as total_hops,
  metadata->'routeInfo'->>'dexes' as dexes,
  metadata
FROM opportunities
WHERE metadata IS NOT NULL
ORDER BY first_detected_at DESC
LIMIT 10;
```

### æ–¹æ³• 3: ä½¿ç”¨ Prisma Studio

```bash
# å¯åŠ¨ Prisma Studioï¼ˆå›¾å½¢åŒ–æ•°æ®åº“æµè§ˆå™¨ï¼‰
cd packages/core
pnpm prisma studio
```

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `http://localhost:5555`ï¼ŒæŸ¥çœ‹ `opportunities` è¡¨çš„ `metadata` å­—æ®µã€‚

---

## ğŸ“ˆ å¯ä»¥åˆ†æçš„ç»´åº¦

### 1ï¸âƒ£ DEX æ€§èƒ½åˆ†æ

**åˆ†æå“ªäº› DEX æä¾›æœ€å¤š/æœ€å¥½çš„å¥—åˆ©æœºä¼š**:
- Orca vs Raydium vs Whirlpool
- å• DEX vs å¤š DEX è·¯ç”±
- DEX ç»„åˆçš„åˆ©æ¶¦ç‡å¯¹æ¯”

### 2ï¸âƒ£ è·¯ç”±å¤æ‚åº¦åˆ†æ

**åˆ†æè·³æ•°ä¸åˆ©æ¶¦çš„å…³ç³»**:
- ç›´æ¥è·¯ç”± (1è·³) çš„åˆ©æ¶¦
- å¤šè·³è·¯ç”± (2-5è·³) çš„åˆ©æ¶¦
- æœ€ä¼˜è·³æ•°æ˜¯å¤šå°‘ï¼Ÿ

### 3ï¸âƒ£ æ¡¥æ¥ä»£å¸åˆ†æ

**åˆ†æå“ªäº›æ¡¥æ¥ä»£å¸æœ€æœ‰åˆ©å¯å›¾**:
- USDC vs USDT vs JUP vs RAY
- ç¨³å®šå¸ vs Meme å¸
- æµåŠ¨æ€§æ·±åº¦çš„å½±å“

### 4ï¸âƒ£ æ—¶é—´åºåˆ—åˆ†æ

**åˆ†æä¸åŒæ—¶é—´æ®µçš„è·¯ç”±æ¨¡å¼**:
- é«˜å³°æ—¶æ®µ vs ä½å³°æ—¶æ®µ
- å·¥ä½œæ—¥ vs å‘¨æœ«
- è·¯ç”±æ¨¡å¼çš„æ—¶é—´å˜åŒ–è¶‹åŠ¿

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### åœºæ™¯ 1: ä¼˜åŒ–æ¡¥æ¥ä»£å¸é€‰æ‹©

```bash
# è¿è¡Œåˆ†æè„šæœ¬ï¼ŒæŸ¥çœ‹ DEX ä½¿ç”¨ç»Ÿè®¡
pnpm tsx analyze-routes.ts

# æ ¹æ®ç»“æœè°ƒæ•´ bridge-tokens.json
# ç§»é™¤ä½æ•ˆçš„æ¡¥æ¥ä»£å¸ï¼Œæ·»åŠ é«˜æ•ˆçš„
```

### åœºæ™¯ 2: è°ƒæ•´è·¯ç”±å‚æ•°

å¦‚æœå‘ç°å¤šè·³è·¯ç”±åˆ©æ¶¦æ›´é«˜ï¼š
```toml
# configs/flashloan-dryrun.toml
[opportunity_finder]
onlyDirectRoutes = false  # å…è®¸å¤šè·³
maxAccounts = 40  # å¢åŠ è´¦æˆ·é™åˆ¶
```

### åœºæ™¯ 3: è¯†åˆ«æœ€ä½³ DEX ç»„åˆ

```sql
-- æŸ¥è¯¢æœ€ç›ˆåˆ©çš„ DEX ç»„åˆ
SELECT 
  metadata->'routeInfo'->>'dexes' as dex_combination,
  COUNT(*) as opportunity_count,
  AVG(first_profit / 1e9) as avg_profit_sol,
  MAX(first_profit / 1e9) as max_profit_sol
FROM opportunities
WHERE metadata->'routeInfo'->>'hasRouteData' = 'true'
GROUP BY dex_combination
ORDER BY avg_profit_sol DESC
LIMIT 10;
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ•°æ®æ¥æº

è·¯ç”±æ•°æ®æ¥è‡ª Jupiter API çš„ `routePlan` å­—æ®µï¼š

```typescript
// query-worker.ts Line 292-293
parentPort.postMessage({
  type: 'opportunity',
  data: {
    // ...
    outRoute: quoteOut.routePlan || [],  // âœ… Jupiter è¿”å›çš„å»ç¨‹è·¯ç”±
    backRoute: quoteBack.routePlan || [], // âœ… Jupiter è¿”å›çš„è¿”ç¨‹è·¯ç”±
    route: [
      ...opportunity.outRoute.map((step: any) => ({
        dex: step.swapInfo?.label || 'Unknown',
        inputMint: step.swapInfo?.inputMint,
        outputMint: step.swapInfo?.outputMint,
        // ...
      })),
      // ...
    ]
  }
});
```

### æ•°æ®æå–

```typescript
// flashloan-bot.ts Line 694-765
private extractRouteMetadata(opportunity: any): any {
  // æå–å»ç¨‹è·¯ç”±
  // æå–è¿”ç¨‹è·¯ç”±
  // ç»Ÿè®¡è·³æ•°
  // æ”¶é›†ä½¿ç”¨çš„ DEX
  // æå–æ¡¥æ¥ä»£å¸ä¿¡æ¯
  // æå–åˆ©æ¶¦åˆ†æ
  return metadata;
}
```

### æ•°æ®å­˜å‚¨

```typescript
// flashloan-bot.ts Line 786-799
await databaseRecorder.recordOpportunity({
  // ...
  metadata: routeMetadata,  // âœ… å­˜å‚¨å®Œæ•´çš„è·¯ç”±å…ƒæ•°æ®
});
```

---

## ğŸ“Š é¢„æœŸæ•°æ®é‡

### å½“å‰é˜ˆå€¼ (2M lamports)
```
æœºä¼šé¢‘ç‡: ~2 ä¸ª/åˆ†é’Ÿ
æ¯å°æ—¶è®°å½•: ~120 æ¡
æ¯å¤©è®°å½•: ~2,880 æ¡
æ¯æœˆè®°å½•: ~86,400 æ¡

å­˜å‚¨å¤§å°: 
  - æ¯æ¡è®°å½• metadata: ~2-5 KB
  - æ¯å¤©: ~5-15 MB
  - æ¯æœˆ: ~150-450 MB
```

### å¦‚æœé™ä½é˜ˆå€¼åˆ° 1M
```
æœºä¼šé¢‘ç‡: ~5-10 ä¸ª/åˆ†é’Ÿ
æ¯å¤©è®°å½•: ~7,200-14,400 æ¡
å­˜å‚¨å¤§å°: æ¯æœˆ ~360-720 MB
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1ï¸âƒ£ æ•°æ®åº“æ€§èƒ½

å¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œå¯ä»¥å®šæœŸæ¸…ç†ï¼š
```sql
-- åˆ é™¤ 30 å¤©å‰çš„æœºä¼šè®°å½•
DELETE FROM opportunities
WHERE first_detected_at < NOW() - INTERVAL '30 days';

-- æˆ–åªä¿ç•™å·²æ‰§è¡Œçš„æœºä¼š
DELETE FROM opportunities
WHERE executed = false AND filtered = true
  AND first_detected_at < NOW() - INTERVAL '7 days';
```

### 2ï¸âƒ£ è·¯ç”±æ•°æ®å¯èƒ½ç¼ºå¤±

æŸäº›æƒ…å†µä¸‹ Jupiter å¯èƒ½ä¸è¿”å› `routePlan`:
- ç›´æ¥è·¯ç”±ï¼ˆå•è·³ï¼‰å¯èƒ½æ²¡æœ‰è¯¦ç»†è·¯ç”±ä¿¡æ¯
- API é”™è¯¯æ—¶å¯èƒ½ç¼ºå¤±
- å¤„ç†æ—¶åº”æ£€æŸ¥ `hasRouteData` å­—æ®µ

### 3ï¸âƒ£ Lite API vs Quote API

å½“å‰ç³»ç»Ÿä½¿ç”¨ **Lite API** (`https://lite-api.jup.ag/swap/v1/quote`)ï¼š
- âœ… è¿”å› `routePlan`ï¼ˆè·¯ç”±è·¯å¾„ï¼‰
- âœ… ç¨³å®šæ€§å¥½ï¼ˆä»£ç†ç¯å¢ƒï¼‰
- âš ï¸ è·¯ç”±å¯èƒ½ä¸å¦‚ Ultra API è¯¦ç»†

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1ï¸âƒ£ å®æ—¶è·¯ç”±ç›‘æ§

åˆ›å»ºå®æ—¶ä»ªè¡¨æ¿æ˜¾ç¤ºï¼š
- å½“å‰æœ€å¸¸ç”¨çš„ DEX
- å®æ—¶åˆ©æ¶¦åˆ†å¸ƒ
- è·¯ç”±å¤æ‚åº¦è¶‹åŠ¿

### 2ï¸âƒ£ æœºå™¨å­¦ä¹ åº”ç”¨

ä½¿ç”¨å†å²è·¯ç”±æ•°æ®è®­ç»ƒæ¨¡å‹ï¼š
- é¢„æµ‹å“ªäº›è·¯ç”±æ›´å¯èƒ½æˆåŠŸ
- é¢„æµ‹æœ€ä½³æ¡¥æ¥ä»£å¸
- ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥

### 3ï¸âƒ£ è·¯ç”±ä¼˜åŒ–ç®—æ³•

åŸºäºå†å²æ•°æ®å¼€å‘ï¼š
- åŠ¨æ€è°ƒæ•´ DEX ä¼˜å…ˆçº§
- æ™ºèƒ½é€‰æ‹©æ¡¥æ¥ä»£å¸
- ä¼˜åŒ– `maxAccounts` å‚æ•°

---

## ğŸ“ ç¤ºä¾‹æŸ¥è¯¢

### æŸ¥è¯¢æœ€è¿‘çš„è·¯ç”±
```bash
pnpm tsx analyze-routes.ts
```

### å¯åŠ¨ Bot å¹¶è®°å½•è·¯ç”±
```bash
pnpm run flashloan-dryrun
```

æ–°å‘ç°çš„æœºä¼šå°†è‡ªåŠ¨è®°å½•è·¯ç”±ä¿¡æ¯åˆ°æ•°æ®åº“ï¼

---

**åŠŸèƒ½çŠ¶æ€**: âœ… å·²å®ç°å¹¶ç¼–è¯‘æˆåŠŸ  
**æ•°æ®åº“è¦æ±‚**: PostgreSQL + Prisma  
**è®°å½•ä½ç½®**: `opportunities.metadata` (JSONB)  
**åˆ†æå·¥å…·**: `analyze-routes.ts`

