# 🛣️ 路由记录功能说明文档

## ✅ 功能概述

系统现在可以**自动记录每个套利机会的完整路由路径**到数据库，用于后续分析和优化。

---

## 📊 记录的路由信息

### 1️⃣ 存储位置

路由信息存储在 `opportunities` 表的 `metadata` 字段中（JSON 格式）

### 2️⃣ 数据结构

```json
{
  "routeInfo": {
    "hasRouteData": true,
    "outboundRoute": [
      {
        "stepNumber": 1,
        "direction": "outbound",
        "dex": "Orca",
        "inputMint": "So11111111...",
        "outputMint": "EPjFWdd5Au...",
        "inputAmount": "10000000000",
        "outputAmount": "1894295485"
      }
    ],
    "returnRoute": [
      {
        "stepNumber": 2,
        "direction": "return",
        "dex": "Raydium",
        "inputMint": "EPjFWdd5Au...",
        "outputMint": "So11111111...",
        "inputAmount": "1894295485",
        "outputAmount": "10002375322"
      }
    ],
    "totalHops": 2,
    "dexes": ["Orca", "Raydium"]
  },
  "bridgeInfo": {
    "symbol": "USDC",
    "mint": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
    "amount": "1894295485"
  },
  "profitAnalysis": {
    "expectedProfit": 2375322,
    "roi": 0.0002375322,
    "inputAmount": 10000000000,
    "outputAmount": 10002375322
  },
  "queryInfo": {
    "queryTime": 493,
    "timestamp": "2025-10-23T14:25:56.210Z"
  }
}
```

---

## 🔬 如何查看路由数据

### 方法 1: 使用分析脚本（推荐）⭐

```bash
# 运行路由分析脚本
pnpm tsx analyze-routes.ts
```

**输出示例**:
```
🔍 正在分析路由数据...

📊 找到 2 条包含元数据的机会记录

1. [filtered] 2025-10-23 22:25:56
   ID: 1
   桥接代币: USDT
   利润: 0.002375 SOL (0.0237%)
   总跳数: 2
   去程路由 (1 步):
     Step 1: Orca
       So111111... → Es9vMFrz...
   返程路由 (1 步):
     Step 2: Raydium
       Es9vMFrz... → So111111...
   使用的 DEX: Orca, Raydium

================================================================================
📊 路由统计汇总
================================================================================

✅ 包含路由数据的机会: 2 条
❌ 不包含路由数据的机会: 0 条

📊 跳数分布:
   2 跳: 2 条 (100.0%)

💰 按跳数的平均利润:
   2 跳: 平均 0.002307 SOL (2 条)

🏦 DEX 使用统计:
   Orca: 2 次 (100.0%)
   Raydium: 2 次 (100.0%)
```

### 方法 2: 直接查询数据库

```sql
-- 查询最近的机会及其路由信息
SELECT 
  id,
  first_detected_at,
  first_profit / 1e9 as profit_sol,
  bridge_token,
  metadata->'routeInfo'->>'totalHops' as total_hops,
  metadata->'routeInfo'->>'dexes' as dexes,
  metadata
FROM opportunities
WHERE metadata IS NOT NULL
ORDER BY first_detected_at DESC
LIMIT 10;
```

### 方法 3: 使用 Prisma Studio

```bash
# 启动 Prisma Studio（图形化数据库浏览器）
cd packages/core
pnpm prisma studio
```

在浏览器中打开 `http://localhost:5555`，查看 `opportunities` 表的 `metadata` 字段。

---

## 📈 可以分析的维度

### 1️⃣ DEX 性能分析

**分析哪些 DEX 提供最多/最好的套利机会**:
- Orca vs Raydium vs Whirlpool
- 单 DEX vs 多 DEX 路由
- DEX 组合的利润率对比

### 2️⃣ 路由复杂度分析

**分析跳数与利润的关系**:
- 直接路由 (1跳) 的利润
- 多跳路由 (2-5跳) 的利润
- 最优跳数是多少？

### 3️⃣ 桥接代币分析

**分析哪些桥接代币最有利可图**:
- USDC vs USDT vs JUP vs RAY
- 稳定币 vs Meme 币
- 流动性深度的影响

### 4️⃣ 时间序列分析

**分析不同时间段的路由模式**:
- 高峰时段 vs 低峰时段
- 工作日 vs 周末
- 路由模式的时间变化趋势

---

## 🎯 应用场景

### 场景 1: 优化桥接代币选择

```bash
# 运行分析脚本，查看 DEX 使用统计
pnpm tsx analyze-routes.ts

# 根据结果调整 bridge-tokens.json
# 移除低效的桥接代币，添加高效的
```

### 场景 2: 调整路由参数

如果发现多跳路由利润更高：
```toml
# configs/flashloan-dryrun.toml
[opportunity_finder]
onlyDirectRoutes = false  # 允许多跳
maxAccounts = 40  # 增加账户限制
```

### 场景 3: 识别最佳 DEX 组合

```sql
-- 查询最盈利的 DEX 组合
SELECT 
  metadata->'routeInfo'->>'dexes' as dex_combination,
  COUNT(*) as opportunity_count,
  AVG(first_profit / 1e9) as avg_profit_sol,
  MAX(first_profit / 1e9) as max_profit_sol
FROM opportunities
WHERE metadata->'routeInfo'->>'hasRouteData' = 'true'
GROUP BY dex_combination
ORDER BY avg_profit_sol DESC
LIMIT 10;
```

---

## 🔧 技术实现

### 数据来源

路由数据来自 Jupiter API 的 `routePlan` 字段：

```typescript
// query-worker.ts Line 292-293
parentPort.postMessage({
  type: 'opportunity',
  data: {
    // ...
    outRoute: quoteOut.routePlan || [],  // ✅ Jupiter 返回的去程路由
    backRoute: quoteBack.routePlan || [], // ✅ Jupiter 返回的返程路由
    route: [
      ...opportunity.outRoute.map((step: any) => ({
        dex: step.swapInfo?.label || 'Unknown',
        inputMint: step.swapInfo?.inputMint,
        outputMint: step.swapInfo?.outputMint,
        // ...
      })),
      // ...
    ]
  }
});
```

### 数据提取

```typescript
// flashloan-bot.ts Line 694-765
private extractRouteMetadata(opportunity: any): any {
  // 提取去程路由
  // 提取返程路由
  // 统计跳数
  // 收集使用的 DEX
  // 提取桥接代币信息
  // 提取利润分析
  return metadata;
}
```

### 数据存储

```typescript
// flashloan-bot.ts Line 786-799
await databaseRecorder.recordOpportunity({
  // ...
  metadata: routeMetadata,  // ✅ 存储完整的路由元数据
});
```

---

## 📊 预期数据量

### 当前阈值 (2M lamports)
```
机会频率: ~2 个/分钟
每小时记录: ~120 条
每天记录: ~2,880 条
每月记录: ~86,400 条

存储大小: 
  - 每条记录 metadata: ~2-5 KB
  - 每天: ~5-15 MB
  - 每月: ~150-450 MB
```

### 如果降低阈值到 1M
```
机会频率: ~5-10 个/分钟
每天记录: ~7,200-14,400 条
存储大小: 每月 ~360-720 MB
```

---

## ⚠️ 注意事项

### 1️⃣ 数据库性能

如果数据量过大，可以定期清理：
```sql
-- 删除 30 天前的机会记录
DELETE FROM opportunities
WHERE first_detected_at < NOW() - INTERVAL '30 days';

-- 或只保留已执行的机会
DELETE FROM opportunities
WHERE executed = false AND filtered = true
  AND first_detected_at < NOW() - INTERVAL '7 days';
```

### 2️⃣ 路由数据可能缺失

某些情况下 Jupiter 可能不返回 `routePlan`:
- 直接路由（单跳）可能没有详细路由信息
- API 错误时可能缺失
- 处理时应检查 `hasRouteData` 字段

### 3️⃣ Lite API vs Quote API

当前系统使用 **Lite API** (`https://lite-api.jup.ag/swap/v1/quote`)：
- ✅ 返回 `routePlan`（路由路径）
- ✅ 稳定性好（代理环境）
- ⚠️ 路由可能不如 Ultra API 详细

---

## 🚀 下一步优化建议

### 1️⃣ 实时路由监控

创建实时仪表板显示：
- 当前最常用的 DEX
- 实时利润分布
- 路由复杂度趋势

### 2️⃣ 机器学习应用

使用历史路由数据训练模型：
- 预测哪些路由更可能成功
- 预测最佳桥接代币
- 优化查询策略

### 3️⃣ 路由优化算法

基于历史数据开发：
- 动态调整 DEX 优先级
- 智能选择桥接代币
- 优化 `maxAccounts` 参数

---

## 📝 示例查询

### 查询最近的路由
```bash
pnpm tsx analyze-routes.ts
```

### 启动 Bot 并记录路由
```bash
pnpm run flashloan-dryrun
```

新发现的机会将自动记录路由信息到数据库！

---

**功能状态**: ✅ 已实现并编译成功  
**数据库要求**: PostgreSQL + Prisma  
**记录位置**: `opportunities.metadata` (JSONB)  
**分析工具**: `analyze-routes.ts`

