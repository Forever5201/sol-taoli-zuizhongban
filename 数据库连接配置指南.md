# 数据库连接配置指南

## 🔴 当前问题

数据库连接失败，原因：PostgreSQL用户名或密码不正确。

```
Authentication failed against database server at `localhost`
```

## 🔍 查找PostgreSQL密码

### 方法1：使用PostgreSQL安装时设置的密码

回忆您在安装PostgreSQL时设置的超级用户（postgres）密码。

### 方法2：重置PostgreSQL密码（如果忘记了）

以管理员身份运行PowerShell：

```powershell
# 1. 找到PostgreSQL安装目录
$pgPath = "C:\Program Files\PostgreSQL\18\bin"  # 根据您的版本调整

# 2. 使用pg_ctl重置密码
cd $pgPath
.\psql.exe -U postgres

# 如果能直接登录（没有密码保护），则执行：
ALTER USER postgres WITH PASSWORD 'your_new_password';
```

### 方法3：使用pgAdmin查看

如果安装了pgAdmin：
1. 打开pgAdmin
2. 右键 "PostgreSQL 18" → Properties
3. 查看连接信息

## ✅ 配置数据库连接

一旦确认了密码，需要更新配置文件。

### 步骤1：更新配置文件

编辑 `configs/flashloan-dryrun.toml`，找到：

```toml
[database]
enabled = true
url = "postgresql://postgres:postgres@localhost:5432/postgres?schema=public"
               #             ^^^^^^^^ 
               #             这里替换为您的实际密码
```

### 步骤2：测试连接

运行测试脚本：

```bash
npx tsx E:\6666666666666666666666666666\dex-cex\dex-sol\test-database-connection.ts
```

应该看到：

```
✅ 数据库连接成功！
📋 已存在的表 (...)
📊 数据统计:
   - 机会记录: 0 条
   - 验证记录: 0 条
🎉 所有测试通过！数据库已就绪。
```

## 🎯 常见数据库URL格式

```
postgresql://[用户名]:[密码]@[主机]:[端口]/[数据库名]

示例：
postgresql://postgres:mypassword@localhost:5432/postgres
postgresql://arbitrage_user:secret123@localhost:5432/arbitrage_db
```

## 🔒 安全建议

### 选项1：使用环境变量（推荐）

1. 在配置文件中使用占位符：
```toml
url = "${DATABASE_URL}"
```

2. 设置系统环境变量：
```
变量名：DATABASE_URL
变量值：postgresql://postgres:your_password@localhost:5432/postgres
```

### 选项2：使用单独的配置文件

创建 `configs/database-secret.toml`（已在.gitignore中）：
```toml
[database]
url = "postgresql://postgres:your_real_password@localhost:5432/postgres"
```

然后在主配置中引用。

## 🛠️ 快速修复脚本

创建 `setup-database.bat`：

```batch
@echo off
echo ================================
echo PostgreSQL 数据库设置
echo ================================
echo.

set /p DB_PASSWORD="请输入PostgreSQL的postgres用户密码: "

echo.
echo 正在测试连接...
psql -U postgres -d postgres -c "SELECT version();"

if %ERRORLEVEL% equ 0 (
    echo ✅ 连接成功！
    echo.
    echo 请将以下URL复制到配置文件中：
    echo postgresql://postgres:%DB_PASSWORD%@localhost:5432/postgres
) else (
    echo ❌ 连接失败，请检查密码
)

pause
```

## 📊 验证数据库就绪

连接成功后，Prisma会自动创建所需的表：

- `Opportunity` - 机会记录
- `OpportunityValidation` - 验证记录  
- `Trade` - 交易记录

可以使用Prisma Studio查看：

```bash
cd packages/core
npx prisma studio
```

然后访问：`http://localhost:5555`

## 🚀 完成后

数据库配置完成后，重启闪电贷机器人：

```bash
start-flashloan-dryrun.bat
```

应该看到：

```
✅ Database initialized for opportunity recording
```

而不是：

```
❌ Authentication failed
```

---

**下一步**：确认PostgreSQL密码，更新配置文件，重新测试！

