# 📊 如何查看延迟统计日志

## ⚠️ 重要发现

之前的日志显示 **`queriesTotal = 0`**，说明所有 Quote API 查询都失败了！

现在已经重新编译并启动，延迟统计功能已生效。

---

## 🔍 查看日志的方法

### **方法 1：查看终端实时日志**

直接查看运行 Bot 的终端窗口，会看到：

#### **单次查询延迟**（实时输出）
```
[Worker 0] ✅ Quote outbound: So11...→USDC, took 120ms, got 9950000000
[Worker 0] ✅ Quote return: USDC→So11..., took 128ms, got 9920000000
```

#### **统计汇总**（每 10 轮扫描）
```
[Worker 0] 📊 ═══════════════ Latency Statistics (Last 20 queries) ═══════════════
[Worker 0] 📊 Outbound (SOL→Bridge): avg 125ms, min 95ms, max 180ms
[Worker 0] 📊 Return (Bridge→SOL):   avg 135ms, min 102ms, max 195ms
[Worker 0] 📊 Total per round:       avg 130ms (10 rounds, 20 queries)
[Worker 0] 📊 Opportunities found:   0
[Worker 0] 📊 ═══════════════════════════════════════════════════════════════════════════
```

---

### **方法 2：查看日志文件**

#### **🚨 重要：日志文件路径可能不存在！**

之前您尝试查看：
```powershell
Get-Content logs\flashloan-dryrun.log -Tail 100
# 报错：找不到路径
```

**可能原因**：
1. ✅ 日志只输出到**控制台**，没有写入文件
2. ✅ 日志文件路径配置错误
3. ✅ 日志目录 `logs/` 不存在

**解决方法**：

#### **A. 检查日志目录是否存在**

```powershell
# 检查 logs 目录
ls logs/

# 如果不存在，创建它
mkdir logs
```

#### **B. 检查实际的日志文件位置**

```powershell
# 查找所有 .log 文件
Get-ChildItem -Path . -Recurse -Filter "*.log" | Select-Object FullName
```

#### **C. 直接查看控制台输出**

如果日志文件不存在，**最可靠的方法是直接查看终端**。

---

### **方法 3：搜索特定关键词**

#### **查找延迟日志**

```powershell
# 如果日志文件存在
Get-Content logs\flashloan-dryrun.log | Select-String "took.*ms"

# 查找统计汇总
Get-Content logs\flashloan-dryrun.log | Select-String "Latency Statistics"

# 查找 Worker 心跳（查看 queriesTotal）
Get-Content logs\flashloan-dryrun.log | Select-String "Heartbeat"
```

---

## 📊 如何解读统计数据

### **1. 单次查询日志**

```
[Worker 0] ✅ Quote outbound: So11...→USDC, took 120ms, got 9950000000
```

**字段说明**：
- `Worker 0`: Worker 线程编号（0, 1, 2）
- `Quote outbound`: 去程查询（SOL → 桥接代币）
- `So11...→USDC`: 交易对（SOL → USDC）
- `took 120ms`: **延迟时间**（关键指标！）
- `got 9950000000`: 报价金额（9.95 USDC）

**延迟范围判断**：
| 延迟 | 状态 | 说明 |
|------|------|------|
| **50-200ms** | ✅ 优秀 | Quote API 表现良好 |
| **200-500ms** | ⚠️ 一般 | 代理网络波动 |
| **500-1000ms** | ❌ 较差 | 代理拥塞 / API 限流 |
| **>1000ms** | 🚨 严重 | TLS 握手失败 / 超时 |

---

### **2. 统计汇总日志**

```
[Worker 0] 📊 ═══════════════ Latency Statistics (Last 20 queries) ═══════════════
[Worker 0] 📊 Outbound (SOL→Bridge): avg 125ms, min 95ms, max 180ms
[Worker 0] 📊 Return (Bridge→SOL):   avg 135ms, min 102ms, max 195ms
[Worker 0] 📊 Total per round:       avg 130ms (10 rounds, 20 queries)
[Worker 0] 📊 Opportunities found:   0
```

**指标说明**：

#### **Outbound (SOL→Bridge)**
- **avg 125ms**: 平均去程延迟
- **min 95ms**: 最快一次查询
- **max 180ms**: 最慢一次查询

**预期**：**~100-150ms**（Quote API 优化后）

#### **Return (Bridge→SOL)**
- **avg 135ms**: 平均回程延迟
- **min 102ms**: 最快一次查询
- **max 195ms**: 最慢一次查询

**预期**：**~100-150ms**（Quote API 优化后）

#### **Total per round**
- **avg 130ms**: 综合平均延迟（去程 + 回程的平均）
- **(10 rounds, 20 queries)**: 已完成 10 轮扫描，20 次查询

**优化效果**：
- **优化前（Ultra API）**: ~500ms
- **优化后（Quote API）**: ~130ms
- **改善**: **-74%** 🎉

#### **Opportunities found**
- **0**: 发现的套利机会数量
- 如果一直是 0，说明当前市场没有符合条件的套利机会

---

### **3. Worker 心跳日志**

```
[Worker 0] 💓 Heartbeat: 82 queries, 0 opportunities
```

**关键指标**：
- **82 queries**: 已完成 82 次查询（**如果是 0，说明所有查询都失败了！**）
- **0 opportunities**: 发现的套利机会数量

**之前的问题**：
```
[Worker 0] 💓 Heartbeat: 0 queries, 0 opportunities  ❌ 所有查询失败！
```

**现在应该看到**：
```
[Worker 0] 💓 Heartbeat: 20 queries, 0 opportunities  ✅ 查询成功！
```

---

## 🎯 现在请检查

### **1. 查看终端窗口**

直接查看运行 Bot 的终端，应该能看到：

```
[Worker 0] ✅ Quote outbound: So11...→USDC, took XXXms, got XXXXXXXXXX
[Worker 0] ✅ Quote return: USDC→So11..., took XXXms, got XXXXXXXXXX
```

### **2. 等待统计汇总**

Bot 运行约 **30 秒后**（10 轮扫描），应该会出现：

```
[Worker 0] 📊 ═══════════════ Latency Statistics ...
```

### **3. 验证查询成功**

关键验证点：
- ✅ `took XXXms` 日志出现了吗？
- ✅ `queriesTotal` 不再是 0 了吗？
- ✅ 延迟在 100-200ms 范围内吗？

---

## ❓ 如果仍然看不到延迟日志

### **可能原因 1：Query API 仍然失败**

**症状**：
- 只有 `🚀 First query starting...`
- 没有 `✅ Quote outbound...` 或 `✅ Quote return...`
- `Heartbeat: 0 queries`

**原因**：
- Quote API 查询超时
- 代理连接失败
- API 返回错误

**验证方法**：
```powershell
# 查看是否有错误日志
# （在终端或日志文件中搜索 "error", "timeout", "failed"）
```

### **可能原因 2：代理问题**

**测试代理**：
```powershell
# 测试代理是否可达
curl -x http://127.0.0.1:7890 https://quote-api.jup.ag/v6/quote?inputMint=So11111111111111111111111111111111111111112&outputMint=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v&amount=1000000000
```

---

## 📝 预期的完整日志流程

```
1. Bot 启动
   ✅ [NetworkConfig] Global proxy configured: http://127.0.0.1:7890
   ✅ Opportunity Finder initialized: 3 workers

2. Worker 预热
   ✅ [Worker 0] 🔥 Warming up connections via Lite API (TLS stable)...
   ✅ [Worker 0] ✅ Connection warmup completed successfully (Lite API)

3. Worker 开始扫描
   ✅ [Worker 0] 🔄 Starting scan round 1...
   ✅ [Worker 0] 🚀 First query starting...
   
4. 查询延迟日志（⭐ 关键！）
   ✅ [Worker 0] ✅ Quote outbound: So11...→USDC, took 120ms, got 9950000000
   ✅ [Worker 0] ✅ Quote return: USDC→So11..., took 128ms, got 9920000000

5. 统计汇总（每 10 轮）
   ✅ [Worker 0] 📊 ═══════════════ Latency Statistics ...
   ✅ [Worker 0] 📊 Outbound (SOL→Bridge): avg 125ms, min 95ms, max 180ms
   ✅ [Worker 0] 📊 Return (Bridge→SOL):   avg 135ms, min 102ms, max 195ms
```

---

**现在请查看终端窗口，确认是否看到 `took XXXms` 日志！** 🚀

