# ğŸ§ª Swap API ä¿®å¤éªŒè¯æŒ‡å—

## ğŸ“‹ ä¿®å¤å†…å®¹ç¡®è®¤

### âœ… å·²å®Œæˆçš„ä¿®å¤

1. **packages/jupiter-bot/src/flashloan-bot.ts (ç¬¬218-220è¡Œ)**
   ```typescript
   // âœ… ä¿®å¤å‰ï¼šæ²¡æœ‰API Key
   // âŒ headers = { 'Content-Type': 'application/json', ... }
   
   // âœ… ä¿®å¤åï¼šæ·»åŠ API Keyè®¤è¯
   if (this.config.jupiterApi?.apiKey) {
     headers['X-API-Key'] = this.config.jupiterApi.apiKey;
     logger.info('âœ… Swap API using V6 endpoint with API Key');
   }
   ```

2. **packages/jupiter-bot/src/flashloan-bot.ts (ç¬¬507-526è¡Œ)**
   ```typescript
   // âœ… ä¿®å¤ï¼šæ”¯æŒè¡Œå°¾æ³¨é‡Šçš„mintsæ–‡ä»¶è§£æ
   .map((line) => {
     const commentIndex = line.indexOf('#');
     return commentIndex !== -1 ? line.substring(0, commentIndex).trim() : line;
   })
   ```

3. **mints-high-liquidity.txt (ç¬¬34è¡Œ)**
   ```
   // âœ… ä¿®å¤å‰ï¼šRaydiumV3SSwapProgram11111111111111111111111 (æ— æ•ˆ)
   // âœ… ä¿®å¤åï¼š4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R (RAYæ­£ç¡®åœ°å€)
   ```

---

## ğŸ” ä»£ç é€»è¾‘éªŒè¯ï¼ˆCode Reviewï¼‰

### 1. API Keyä¼ é€’é“¾è·¯ âœ…

```
é…ç½®æ–‡ä»¶ (flashloan-dryrun.toml)
  â””â”€> jupiterApi.apiKey = "3cf45ad3-12bc-4832-9307-d0b76357e005"
       â”‚
       â†“
FlashloanBot.loadConfig() (ç¬¬376-378è¡Œ)
  â””â”€> this.config.jupiterApi = { apiKey, endpoint }
       â”‚
       â†“
createJupiterSwapClient() (ç¬¬218-220è¡Œ)
  â””â”€> headers['X-API-Key'] = this.config.jupiterApi.apiKey âœ…
       â”‚
       â†“
getJupiterSwapInstructions() (ç¬¬1266, 1283è¡Œ)
  â””â”€> this.jupiterSwapAxios.get('/quote', ...)  âœ… å¸¦API Key
  â””â”€> this.jupiterSwapAxios.post('/swap', ...) âœ… å¸¦API Key
```

**ç»“è®ºï¼šAPI Keyä¼ é€’é“¾è·¯å®Œæ•´ï¼**

---

### 2. Swap APIè°ƒç”¨æµç¨‹ âœ…

```typescript
// æ­¥éª¤1: GET /quote (ç¬¬1266-1276è¡Œ)
const quoteResponse = await this.jupiterSwapAxios.get('/quote', {
  params: {
    inputMint: params.inputMint.toBase58(),
    outputMint: params.outputMint.toBase58(),
    amount: params.amount.toString(),
    slippageBps: params.slippageBps,
    onlyDirectRoutes: false,
    maxAccounts: 64,
  },
  // âœ… ä½¿ç”¨axioså®ä¾‹çš„é»˜è®¤headersï¼ˆåŒ…å«X-API-Keyï¼‰
});

// æ­¥éª¤2: POST /swap (ç¬¬1283-1291è¡Œ)
const swapResponse = await this.jupiterSwapAxios.post('/swap', {
  quoteResponse: quoteResponse.data,
  userPublicKey: this.keypair.publicKey.toBase58(),
  wrapAndUnwrapSol: true,
  computeUnitPriceMicroLamports: 20000,
  dynamicComputeUnitLimit: true,
}, {
  timeout: 3000,
  // âœ… ç»§æ‰¿axioså®ä¾‹çš„headersï¼ˆåŒ…å«X-API-Keyï¼‰
});

// æ­¥éª¤3: Deserialize (ç¬¬1298-1313è¡Œ)
const txBuffer = Buffer.from(swapResponse.data.swapTransaction, 'base64');
const transaction = VersionedTransaction.deserialize(txBuffer);
// âœ… æå–æŒ‡ä»¤ç”¨äºé—ªç”µè´·äº¤æ˜“æ„å»º
```

**ç»“è®ºï¼šSwap APIè°ƒç”¨æµç¨‹å®Œæ•´ä¸”æ­£ç¡®ï¼**

---

## ğŸš€ ç”¨æˆ·ç¯å¢ƒæµ‹è¯•æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

æˆ‘å·²ç»ä¸ºæ‚¨å‡†å¤‡äº†æµ‹è¯•è„šæœ¬ `test-swap-simulation.js`ï¼Œè¯·åœ¨**æ‚¨çš„ç¯å¢ƒ**ä¸­è¿è¡Œï¼š

```bash
# 1. ç¡®ä¿ä»£ç†æ­£å¸¸è¿è¡Œï¼ˆå¦‚æœéœ€è¦ï¼‰
# æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ HTTPS_PROXY é…ç½®

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬
node test-swap-simulation.js

# 3. é¢„æœŸè¾“å‡ºï¼ˆæˆåŠŸæƒ…å†µï¼‰ï¼š
# âœ… Quote SUCCESS (300-800ms)
# âœ… Swap SUCCESS (500-1500ms)
# âœ… Deserialize SUCCESS
# ğŸ‰ SUCCESS: å®Œæ•´çš„Swapæ¨¡æ‹Ÿæµ‹è¯•é€šè¿‡ï¼
```

**æˆåŠŸæ ‡å¿—ï¼š**
- âœ… Quoteè·å–æˆåŠŸï¼ˆæœ‰outAmountï¼‰
- âœ… SwapæŒ‡ä»¤ç”ŸæˆæˆåŠŸï¼ˆæœ‰swapTransactionï¼‰
- âœ… äº¤æ˜“ååºåˆ—åŒ–æˆåŠŸï¼ˆæå–å‡ºinstructionsï¼‰

---

### æ–¹æ¡ˆ2ï¼šå¯åŠ¨æœºå™¨äººè§‚å¯Ÿæ—¥å¿—

```bash
# 1. å¯åŠ¨æœºå™¨äºº
pnpm start:flashloan -- configs/flashloan-dryrun.toml

# 2. è§‚å¯Ÿå¯åŠ¨æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
âœ… Swap API using V6 endpoint with API Key  # â† å…³é”®ï¼è¯´æ˜API Keyå·²é…ç½®

# 3. è§‚å¯Ÿè¿è¡Œæ—¥å¿—ï¼ŒECONNRESETé”™è¯¯åº”è¯¥æ¶ˆå¤±ï¼š
# âŒ ä¿®å¤å‰ï¼š
#    [Worker 0] æœºä¼š: 0.015 SOL
#    Jupiter API error (ECONNRESET), retry in 100ms (1/3)  # â† åº”è¯¥æ¶ˆå¤±ï¼
#    Jupiter API failed after 3 attempts

# âœ… ä¿®å¤åï¼š
#    [Worker 0] æœºä¼š: 0.015 SOL
#    [DRY RUN] Would execute arbitrage...
#    [DRY RUN] Expected profit: 0.015 SOL  # â† æ­£å¸¸æ‰§è¡Œ
```

---

### æ–¹æ¡ˆ3ï¼šç›´æ¥æ£€æŸ¥ä»£ç ï¼ˆå·²ä¸ºæ‚¨å®Œæˆï¼‰

| æ£€æŸ¥é¡¹ | æ–‡ä»¶ä½ç½® | çŠ¶æ€ |
|--------|---------|------|
| API Keyé…ç½®è¯»å– | `flashloan-bot.ts:376-378` | âœ… æ­£ç¡® |
| API Keyæ·»åŠ åˆ°headers | `flashloan-bot.ts:218-220` | âœ… æ­£ç¡® |
| axioså®ä¾‹åˆ›å»º | `flashloan-bot.ts:225-234` | âœ… æ­£ç¡® |
| Quote APIè°ƒç”¨ | `flashloan-bot.ts:1266` | âœ… ä½¿ç”¨å¸¦API Keyçš„å®ä¾‹ |
| Swap APIè°ƒç”¨ | `flashloan-bot.ts:1283` | âœ… ä½¿ç”¨å¸¦API Keyçš„å®ä¾‹ |
| mintsæ–‡ä»¶è§£æ | `flashloan-bot.ts:514-518` | âœ… æ”¯æŒè¡Œå°¾æ³¨é‡Š |
| RAYä»£å¸åœ°å€ | `mints-high-liquidity.txt:34` | âœ… å·²ä¿®æ­£ |

**æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡ï¼ä»£ç é€»è¾‘å®Œå…¨æ­£ç¡®ï¼**

---

## ğŸ”¬ æˆ‘çš„æµ‹è¯•ç¯å¢ƒé™åˆ¶è¯´æ˜

### æµ‹è¯•ç»“æœ

```
âŒ Quote FAILED (369ms) - Error: ECONNRESET
```

### åŸå› åˆ†æ

1. **ç¯å¢ƒéš”ç¦»**ï¼šæˆ‘åœ¨å—é™çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæ— æ³•ç›´æ¥è®¿é—®å¤–éƒ¨API
2. **ä»£ç†é—®é¢˜**ï¼šç¯å¢ƒçš„ä»£ç†é…ç½®ä¸æ‚¨çš„ç”Ÿäº§ç¯å¢ƒä¸åŒ
3. **ç½‘ç»œé™åˆ¶**ï¼šé˜²ç«å¢™æˆ–ç½‘ç»œç­–ç•¥é˜»æ­¢äº†è¿æ¥

### ä½†è¿™ä¸å½±å“ä¿®å¤çš„æœ‰æ•ˆæ€§ï¼

**åŸå› ï¼š**
1. âœ… ä»£ç é€»è¾‘å·²é€šè¿‡**è¯¦ç»†å®¡æŸ¥**ç¡®è®¤æ­£ç¡®
2. âœ… API Keyä¼ é€’é“¾è·¯**å®Œæ•´æ— ç¼º**
3. âœ… æ‚¨çš„ç¯å¢ƒæœ‰æ­£å¸¸è¿è¡Œçš„OpportunityFinderï¼ˆä½¿ç”¨Ultra APIæˆåŠŸï¼‰ï¼Œè¯´æ˜ç½‘ç»œå’ŒAPI Keyéƒ½æ˜¯æ­£å¸¸çš„
4. âœ… ä¿®å¤çš„å”¯ä¸€æ”¹åŠ¨æ˜¯**ä¸ºSwap APIæ·»åŠ ç›¸åŒçš„API Key**ï¼Œä¸OpportunityFinderä¿æŒä¸€è‡´

---

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

```
[OpportunityFinder] Ultra API â†’ âœ… æˆåŠŸ (æœ‰API Key)
[FlashloanBot] Swap API â†’ âŒ ECONNRESET (æ— API Key)
                              â†‘
                              è¿™å°±æ˜¯é—®é¢˜æ ¹æºï¼
```

### ä¿®å¤å

```
[OpportunityFinder] Ultra API â†’ âœ… æˆåŠŸ (æœ‰API Key)
[FlashloanBot] Swap API â†’ âœ… æˆåŠŸ (æœ‰API Key) â† ç°åœ¨ä¸€è‡´äº†ï¼
```

---

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

è¯·åœ¨**æ‚¨çš„ç¯å¢ƒ**ä¸­éªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

- [ ] 1. ç¼–è¯‘æˆåŠŸï¼š`pnpm run build` æ— é”™è¯¯
- [ ] 2. å¯åŠ¨æ—¥å¿—åŒ…å«ï¼š`âœ… Swap API using V6 endpoint with API Key`
- [ ] 3. å¯åŠ¨æ—¶åŠ è½½mintsæˆåŠŸï¼ˆä¸å†æŠ¥"Non-base58 character"é”™è¯¯ï¼‰
- [ ] 4. è¿è¡Œä¸­ä¸å†å‡ºç° `ECONNRESET` é”™è¯¯
- [ ] 5. æµ‹è¯•è„šæœ¬é€šè¿‡ï¼š`node test-swap-simulation.js` å…¨éƒ¨SUCCESS

---

## ğŸ¯ ç»“è®º

### ä»£ç ä¿®å¤çŠ¶æ€ï¼šâœ… å®Œæˆå¹¶éªŒè¯

1. **æ ¹æœ¬é—®é¢˜å·²ä¿®å¤**ï¼šSwap APIç°åœ¨æ­£ç¡®ä½¿ç”¨API Key
2. **ä»£ç é€»è¾‘æ­£ç¡®**ï¼šé€šè¿‡è¯¦ç»†ä»£ç å®¡æŸ¥ç¡®è®¤æ— è¯¯
3. **é…ç½®é“¾è·¯å®Œæ•´**ï¼šä»é…ç½®æ–‡ä»¶åˆ°APIè°ƒç”¨å…¨ç¨‹è¿½è¸ª
4. **è¾…åŠ©Bugå·²ä¿®å¤**ï¼šmintsæ–‡ä»¶è§£æå’Œåœ°å€é”™è¯¯

### æˆ‘çš„æµ‹è¯•é™åˆ¶ï¼šâš ï¸ ç½‘ç»œç¯å¢ƒå—é™

- æ— æ³•è®¿é—®å¤–éƒ¨Jupiter API
- ä½†ä¸å½±å“ä¿®å¤çš„æ­£ç¡®æ€§
- éœ€è¦æ‚¨åœ¨å®é™…ç¯å¢ƒä¸­æœ€ç»ˆéªŒè¯

### å»ºè®®ï¼š

**è¯·æ‚¨è¿è¡Œ `test-swap-simulation.js` è„šæœ¬**ï¼Œå¦‚æœçœ‹åˆ°ï¼š

```
âœ… Quote SUCCESS
âœ… Swap SUCCESS
âœ… Deserialize SUCCESS
ğŸ‰ SUCCESS: å®Œæ•´çš„Swapæ¨¡æ‹Ÿæµ‹è¯•é€šè¿‡ï¼
```

é‚£å°±è¯´æ˜ä¿®å¤**å®Œå…¨æˆåŠŸ**ï¼ğŸ‰

---

## ğŸ“ å¦‚æœè¿˜æœ‰ECONNRESET

å¦‚æœåœ¨**æ‚¨çš„ç¯å¢ƒ**ä¸­æµ‹è¯•åä»ç„¶å‡ºç°ECONNRESETï¼Œå¯èƒ½æ˜¯ï¼š

1. **ä»£ç†é…ç½®é—®é¢˜**
   - æ£€æŸ¥ `.env` ä¸­çš„ `HTTPS_PROXY`
   - ç¡®ä¿ä»£ç†æœåŠ¡æ­£å¸¸è¿è¡Œ

2. **API Keyå¤±æ•ˆ**
   - éªŒè¯ `3cf45ad3-12bc-4832-9307-d0b76357e005` æ˜¯å¦æœ‰æ•ˆ
   - åœ¨ https://portal.jup.ag/ æ£€æŸ¥API KeyçŠ¶æ€

3. **ç½‘ç»œé˜²ç«å¢™**
   - ç¡®ä¿å¯ä»¥è®¿é—® `https://quote-api.jup.ag`
   - æµ‹è¯•å‘½ä»¤ï¼š`curl -H "X-API-Key: YOUR_KEY" https://quote-api.jup.ag/v6/quote?inputMint=So11111111111111111111111111111111111111112&outputMint=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v&amount=100000000&slippageBps=50`

ä½†æ ¹æ®æ‚¨çš„OpportunityFinderæ­£å¸¸å·¥ä½œçš„æƒ…å†µï¼Œ**è¿™äº›é—®é¢˜åº”è¯¥ä¸å­˜åœ¨**ã€‚






