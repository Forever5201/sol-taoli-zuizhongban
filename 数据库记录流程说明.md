# æ•°æ®åº“è®°å½•æµç¨‹å®Œæ•´è¯´æ˜

## âœ… æ˜¯çš„ï¼Œæ•°æ®åº“ä¼šå®Œæ•´è®°å½•æ‰€æœ‰é€šè¿‡äºŒæ¬¡éªŒè¯çš„æœºä¼šï¼

---

## ğŸ“Š å®Œæ•´è®°å½•æµç¨‹

### é˜¶æ®µ1ï¸âƒ£: æœºä¼šé¦–æ¬¡å‘ç° (Workerå‘ç°)

**è§¦å‘**: WorkeræŸ¥è¯¢å‘ç°å¥—åˆ©æœºä¼š

**è®°å½•ä½ç½®**: `packages/jupiter-bot/src/flashloan-bot.ts` Line 879

```typescript
opportunityId = await databaseRecorder.recordOpportunity({
  inputMint: opportunity.inputMint.toBase58(),
  outputMint: opportunity.outputMint.toBase58(),
  bridgeToken: opportunity.bridgeToken,  // "USDC", "USDT" ç­‰
  bridgeMint: opportunity.bridgeMint?.toBase58(),
  inputAmount: BigInt(opportunity.inputAmount),
  outputAmount: BigInt(opportunity.outputAmount),
  bridgeAmount: opportunity.bridgeAmount ? BigInt(opportunity.bridgeAmount) : undefined,
  expectedProfit: firstProfit,  // é¦–æ¬¡å‘ç°çš„åˆ©æ¶¦
  expectedRoi: firstRoi,        // é¦–æ¬¡å‘ç°çš„ROI
  executed: false,              // å°šæœªæ‰§è¡Œ
  filtered: false,              // å°šæœªè¿‡æ»¤
  metadata: routeMetadata,      // ğŸ”¥ è·¯ç”±è¯¦æƒ…ï¼ˆåŒ…å«DEXã€è·³æ•°ç­‰ï¼‰
});
```

**æ•°æ®åº“è¡¨**: `Opportunity`

**è®°å½•å†…å®¹**:
- âœ… è¾“å…¥/è¾“å‡ºä»£å¸åœ°å€
- âœ… æ¡¥æ¥ä»£å¸ï¼ˆUSDC/USDTç­‰ï¼‰
- âœ… é‡‘é¢ï¼ˆè¾“å…¥/è¾“å‡º/æ¡¥æ¥ï¼‰
- âœ… é¢„æœŸåˆ©æ¶¦å’ŒROI
- âœ… è·¯ç”±å…ƒæ•°æ®ï¼ˆäº¤æ˜“è·¯å¾„ã€DEXä¿¡æ¯ï¼‰
- âœ… å‘ç°æ—¶é—´ (`discoveredAt`)

**æ—¥å¿—**:
```
ğŸ“ Recorded opportunity #123 with route metadata
```

---

### é˜¶æ®µ2ï¸âƒ£: äºŒæ¬¡éªŒè¯ (Botç«‹å³éªŒè¯)

**è§¦å‘**: æœºä¼šå‘ç°åç«‹å³æ‰§è¡ŒäºŒæ¬¡éªŒè¯

**è®°å½•ä½ç½®**: `packages/jupiter-bot/src/flashloan-bot.ts` Line 914

```typescript
await databaseRecorder.recordOpportunityValidation({
  opportunityId,                  // å…³è”åˆ°é˜¶æ®µ1çš„è®°å½•
  firstDetectedAt,                // é¦–æ¬¡å‘ç°æ—¶é—´
  firstProfit,                    // é¦–æ¬¡åˆ©æ¶¦
  firstRoi,                       // é¦–æ¬¡ROI
  secondCheckedAt: new Date(),    // äºŒæ¬¡éªŒè¯æ—¶é—´
  stillExists: revalidation.stillExists,  // âœ… æ˜¯å¦ä»å­˜åœ¨
  secondProfit: revalidation.stillExists ? BigInt(revalidation.secondProfit) : undefined,
  secondRoi: revalidation.stillExists ? revalidation.secondRoi : undefined,
  validationDelayMs: revalidation.delayMs,  // éªŒè¯å»¶è¿Ÿ
  // ğŸ”¥ è¯¦ç»†å»¶è¿Ÿæ•°æ®
  firstOutboundMs: opportunity.latency?.outboundMs,   // é¦–æ¬¡å»ç¨‹å»¶è¿Ÿ
  firstReturnMs: opportunity.latency?.returnMs,       // é¦–æ¬¡å›ç¨‹å»¶è¿Ÿ
  secondOutboundMs: revalidation.secondOutboundMs,    // éªŒè¯å»ç¨‹å»¶è¿Ÿ
  secondReturnMs: revalidation.secondReturnMs,        // éªŒè¯å›ç¨‹å»¶è¿Ÿ
});
```

**æ•°æ®åº“è¡¨**: `OpportunityValidation`

**è®°å½•å†…å®¹**:
- âœ… é¦–æ¬¡å’ŒäºŒæ¬¡çš„åˆ©æ¶¦å¯¹æ¯”
- âœ… é¦–æ¬¡å’ŒäºŒæ¬¡çš„ROIå¯¹æ¯”
- âœ… éªŒè¯å»¶è¿Ÿï¼ˆæ€»æ—¶é—´ï¼‰
- âœ… è¯¦ç»†APIæŸ¥è¯¢å»¶è¿Ÿï¼ˆ4ä¸ªå­—æ®µï¼‰
- âœ… `stillExists` çŠ¶æ€ï¼ˆ**è¿™æ˜¯å…³é”®ï¼**ï¼‰

**æ—¥å¿—**:
```
ğŸ“Š Validation result: stillExists=true, profit=0.000116 SOL (0.00%), delay=172ms
```

---

### é˜¶æ®µ3ï¸âƒ£: è¿‡æ»¤åˆ¤æ–­ (å¦‚æœéªŒè¯å¤±è´¥æˆ–RPCå¤±è´¥)

#### æƒ…å†µA: äºŒæ¬¡éªŒè¯å¤±è´¥ (stillExists=false)

**è§¦å‘**: æœºä¼šåœ¨äºŒæ¬¡éªŒè¯æ—¶å·²æ¶ˆå¤±

**è®°å½•ä½ç½®**: `packages/jupiter-bot/src/flashloan-bot.ts` Line 940

```typescript
await databaseRecorder.markOpportunityFiltered(
  opportunityId,
  `Expired on re-validation: profit dropped to ${profit} SOL`
);
```

**æ›´æ–°**: `Opportunity.filtered = true`, `Opportunity.filterReason = "Expired..."`

**æ—¥å¿—**:
```
â±ï¸ Opportunity expired after 172ms, skipping execution
```

#### æƒ…å†µB: RPCæ¨¡æ‹Ÿå¤±è´¥ (InsufficientFundsForFeeç­‰)

**è§¦å‘**: äºŒæ¬¡éªŒè¯é€šè¿‡ï¼Œä½†RPCæ¨¡æ‹Ÿå¤±è´¥

**è®°å½•ä½ç½®**: `packages/jupiter-bot/src/flashloan-bot.ts` Line 1091

```typescript
await databaseRecorder.markOpportunityFiltered(
  opportunityId,
  `RPC simulation failed: ${simulation.reason}`
);
```

**æ›´æ–°**: `Opportunity.filtered = true`, `Opportunity.filterReason = "RPC simulation failed..."`

**æ—¥å¿—**:
```
âŒ Simulation failed (1483ms)
   Reason: InsufficientFundsForFee
   ğŸ‰ Saved 0.116 SOL (Gas + Tip) by filtering invalid opportunity
```

---

## ğŸ“‹ æ•°æ®åº“è¡¨ç»“æ„

### è¡¨1: `Opportunity` (æœºä¼šè®°å½•è¡¨)

```sql
CREATE TABLE "Opportunity" (
  id BIGSERIAL PRIMARY KEY,
  input_mint TEXT NOT NULL,
  output_mint TEXT NOT NULL,
  bridge_token TEXT,           -- "USDC", "USDT"
  bridge_mint TEXT,
  input_amount BIGINT NOT NULL,
  output_amount BIGINT NOT NULL,
  bridge_amount BIGINT,
  expected_profit BIGINT NOT NULL,  -- é¦–æ¬¡å‘ç°åˆ©æ¶¦
  expected_roi DOUBLE PRECISION NOT NULL,
  executed BOOLEAN DEFAULT false,
  filtered BOOLEAN DEFAULT false,   -- âœ… æ˜¯å¦è¢«è¿‡æ»¤
  filter_reason TEXT,               -- âœ… è¿‡æ»¤åŸå› 
  metadata JSONB,                   -- ğŸ”¥ è·¯ç”±å…ƒæ•°æ®
  discovered_at TIMESTAMP NOT NULL DEFAULT NOW(),
  -- ... å…¶ä»–å­—æ®µ
);
```

### è¡¨2: `OpportunityValidation` (éªŒè¯è®°å½•è¡¨)

```sql
CREATE TABLE "OpportunityValidation" (
  id BIGSERIAL PRIMARY KEY,
  opportunity_id BIGINT REFERENCES "Opportunity"(id),
  first_detected_at TIMESTAMP NOT NULL,
  first_profit BIGINT NOT NULL,
  first_roi DOUBLE PRECISION NOT NULL,
  second_checked_at TIMESTAMP NOT NULL,
  still_exists BOOLEAN NOT NULL,    -- âœ… å…³é”®å­—æ®µï¼
  second_profit BIGINT,
  second_roi DOUBLE PRECISION,
  validation_delay_ms INT NOT NULL,
  -- ğŸ”¥ è¯¦ç»†å»¶è¿Ÿæ•°æ®
  first_outbound_ms INT,
  first_return_ms INT,
  second_outbound_ms INT,
  second_return_ms INT,
  -- ... å…¶ä»–å­—æ®µ
);
```

---

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢1: æ‰€æœ‰é€šè¿‡äºŒæ¬¡éªŒè¯çš„æœºä¼š

```sql
SELECT 
  o.id,
  o.bridge_token,
  o.expected_profit / 1000000000.0 AS first_profit_sol,
  v.second_profit / 1000000000.0 AS second_profit_sol,
  v.still_exists,
  v.validation_delay_ms,
  o.filtered,
  o.filter_reason,
  o.discovered_at
FROM "Opportunity" o
JOIN "OpportunityValidation" v ON v.opportunity_id = o.id
WHERE v.still_exists = true  -- âœ… é€šè¿‡äºŒæ¬¡éªŒè¯
ORDER BY o.discovered_at DESC
LIMIT 20;
```

### æŸ¥è¯¢2: é€šè¿‡éªŒè¯ä½†è¢«RPCè¿‡æ»¤çš„æœºä¼š

```sql
SELECT 
  o.id,
  o.bridge_token,
  v.second_profit / 1000000000.0 AS profit_sol,
  o.filter_reason,
  o.discovered_at
FROM "Opportunity" o
JOIN "OpportunityValidation" v ON v.opportunity_id = o.id
WHERE v.still_exists = true       -- âœ… é€šè¿‡äºŒæ¬¡éªŒè¯
  AND o.filtered = true           -- âš ï¸ ä½†è¢«è¿‡æ»¤äº†
  AND o.filter_reason LIKE '%RPC simulation%'  -- åŸå› æ˜¯RPCæ¨¡æ‹Ÿå¤±è´¥
ORDER BY o.discovered_at DESC;
```

### æŸ¥è¯¢3: åˆ©æ¶¦ä¸‹é™ç»Ÿè®¡

```sql
SELECT 
  o.bridge_token,
  COUNT(*) AS total_opportunities,
  AVG((v.second_profit - o.expected_profit)::FLOAT / o.expected_profit * 100) AS avg_profit_change_pct,
  AVG(v.validation_delay_ms) AS avg_validation_delay_ms
FROM "Opportunity" o
JOIN "OpportunityValidation" v ON v.opportunity_id = o.id
WHERE v.still_exists = true
GROUP BY o.bridge_token
ORDER BY total_opportunities DESC;
```

### æŸ¥è¯¢4: å»¶è¿Ÿåˆ†æ

```sql
SELECT 
  o.id,
  o.bridge_token,
  v.first_outbound_ms + v.first_return_ms AS first_total_ms,
  v.second_outbound_ms + v.second_return_ms AS second_total_ms,
  v.validation_delay_ms,
  v.still_exists
FROM "Opportunity" o
JOIN "OpportunityValidation" v ON v.opportunity_id = o.id
WHERE v.still_exists = true
ORDER BY v.validation_delay_ms ASC
LIMIT 20;
```

---

## ğŸ“Š å®é™…æ¡ˆä¾‹åˆ†æ

### ä½ åˆšæ‰çœ‹åˆ°çš„æ—¥å¿—å¯¹åº”çš„æ•°æ®åº“è®°å½•

**Opportunityè¡¨**:
```
id: 123 (å‡è®¾)
bridge_token: "USDC"
expected_profit: 2100000 (0.0021 SOL - é¦–æ¬¡å‘ç°)
expected_roi: 0.0002
filtered: true  âœ…
filter_reason: "RPC simulation failed: InsufficientFundsForFee"  âœ…
discovered_at: 2025-10-24 03:04:05
```

**OpportunityValidationè¡¨**:
```
opportunity_id: 123
still_exists: true  âœ… (å…³é”®ï¼šè¯´æ˜é€šè¿‡äº†äºŒæ¬¡éªŒè¯)
first_profit: 2100000
second_profit: 116000  (åˆ©æ¶¦ä¸‹é™94.5%)
validation_delay_ms: 172
first_outbound_ms: (ä»Workerå»¶è¿Ÿæ•°æ®)
first_return_ms: (ä»Workerå»¶è¿Ÿæ•°æ®)
second_outbound_ms: (ä»äºŒæ¬¡éªŒè¯æ•°æ®)
second_return_ms: (ä»äºŒæ¬¡éªŒè¯æ•°æ®)
```

**è§£è¯»**:
1. âœ… æœºä¼šè¢«è®°å½•åˆ° `Opportunity` è¡¨
2. âœ… äºŒæ¬¡éªŒè¯è®°å½•åˆ° `OpportunityValidation` è¡¨ï¼Œ`still_exists=true`
3. âœ… RPCæ¨¡æ‹Ÿå¤±è´¥åï¼Œ`Opportunity.filtered=true` è¢«è®¾ç½®
4. âœ… å®Œæ•´çš„å»¶è¿Ÿæ•°æ®è¢«ä¿å­˜ï¼ˆ4ä¸ªå»¶è¿Ÿå­—æ®µï¼‰

---

## ğŸ¯ æ€»ç»“

### æ•°æ®åº“ä¼šè®°å½•ä»€ä¹ˆï¼Ÿ

âœ… **100%è®°å½•**:
- æ‰€æœ‰é¦–æ¬¡å‘ç°çš„æœºä¼š
- æ‰€æœ‰äºŒæ¬¡éªŒè¯ç»“æœï¼ˆåŒ…æ‹¬é€šè¿‡å’Œå¤±è´¥ï¼‰
- æ‰€æœ‰å»¶è¿Ÿæ•°æ®ï¼ˆé¦–æ¬¡+äºŒæ¬¡ï¼Œå»ç¨‹+å›ç¨‹ï¼‰
- æ‰€æœ‰è¿‡æ»¤åŸå› ï¼ˆéªŒè¯å¤±è´¥ã€RPCå¤±è´¥ç­‰ï¼‰

âœ… **é€šè¿‡äºŒæ¬¡éªŒè¯çš„æœºä¼šç‰¹å¾**:
- `OpportunityValidation.still_exists = true`
- æœ‰å®Œæ•´çš„ `second_profit` å’Œ `second_roi` æ•°æ®
- æœ‰å®Œæ•´çš„å»¶è¿Ÿåˆ†ææ•°æ®

âœ… **è¢«è¿‡æ»¤çš„æœºä¼šç‰¹å¾**:
- `Opportunity.filtered = true`
- `Opportunity.filter_reason` è¯´æ˜åŸå› 
- ä½† `OpportunityValidation` è®°å½•ä»ç„¶å­˜åœ¨ï¼ˆç”¨äºç»Ÿè®¡åˆ†æï¼‰

### å¾®ä¿¡æ¨é€ vs æ•°æ®åº“è®°å½•

| æœºä¼šç±»å‹ | æ•°æ®åº“è®°å½• | å¾®ä¿¡æ¨é€ |
|---------|-----------|---------|
| é¦–æ¬¡å‘ç° | âœ… è®°å½• | âŒ ä¸æ¨é€ |
| äºŒæ¬¡éªŒè¯é€šè¿‡ | âœ… è®°å½• | âœ… æ¨é€ï¼ˆåˆ©æ¶¦â‰¥0.0001 SOLï¼‰ |
| äºŒæ¬¡éªŒè¯å¤±è´¥ | âœ… è®°å½• | âŒ ä¸æ¨é€ |
| RPCæ¨¡æ‹Ÿå¤±è´¥ | âœ… è®°å½• | âŒ ä¸æ¨é€ï¼ˆåœ¨æ¨é€å‰å°±è¢«è¿‡æ»¤ï¼‰ |

### æŸ¥è¯¢ä½ çš„å†å²è®°å½•

```bash
# è¿æ¥æ•°æ®åº“
psql -U postgres -d postgres

# æŸ¥è¯¢æœ€è¿‘20ä¸ªé€šè¿‡äºŒæ¬¡éªŒè¯çš„æœºä¼š
SELECT 
  o.id,
  o.bridge_token,
  o.expected_profit / 1000000000.0 AS first_profit_sol,
  v.second_profit / 1000000000.0 AS second_profit_sol,
  o.filtered,
  o.filter_reason,
  o.discovered_at
FROM "Opportunity" o
JOIN "OpportunityValidation" v ON v.opportunity_id = o.id
WHERE v.still_exists = true
ORDER BY o.discovered_at DESC
LIMIT 20;
```

---

## ğŸ“ˆ æ•°æ®ä»·å€¼

é€šè¿‡å®Œæ•´çš„æ•°æ®åº“è®°å½•ï¼Œä½ å¯ä»¥åˆ†æï¼š

1. **åˆ©æ¶¦è¡°å‡ç‡**: äºŒæ¬¡éªŒè¯ååˆ©æ¶¦å¹³å‡ä¸‹é™å¤šå°‘%
2. **éªŒè¯å»¶è¿Ÿå½±å“**: å»¶è¿Ÿä¸åˆ©æ¶¦ä¸‹é™çš„å…³ç³»
3. **ä»£å¸è¡¨ç°**: å“ªä¸ªæ¡¥æ¥ä»£å¸çš„æœºä¼šæ›´ç¨³å®š
4. **è¿‡æ»¤åŸå› **: ä¸ºä»€ä¹ˆæœºä¼šè¢«è¿‡æ»¤ï¼ˆä½™é¢ä¸è¶³ã€åˆ©æ¶¦æ¶ˆå¤±ç­‰ï¼‰
5. **APIå»¶è¿Ÿ**: Ultra APIçš„å»ç¨‹/å›ç¨‹å»¶è¿Ÿåˆ†å¸ƒ
6. **æˆåŠŸç‡**: é€šè¿‡éªŒè¯çš„æœºä¼šå æ¯”

**ä½ çš„æ‰€æœ‰æ•°æ®éƒ½åœ¨ï¼** ğŸ‰

