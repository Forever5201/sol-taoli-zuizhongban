# 🎯 速率限制问题 - 根本原因与修复

## 🔴 问题根源

### 发现的根本原因

**您的Bot超过Jupiter Lite API速率限制 20倍！**

```
Jupiter Lite API限制: 60次请求 / 60秒 = 1次/秒

您的配置（200ms间隔）:
  - 1 Worker × 2桥接代币 × 2方向 = 4次API调用/轮
  - 每200ms一轮 = 5轮/秒
  - 4次 × 5轮 = 20次/秒
  - 20次/秒 × 60秒 = 1,200次/分钟

对比:
  1,200次/分钟 vs 60次/分钟 = 超限 20倍！🔴
```

**这就是96%查询失败的真正原因！**

---

## ✅ 修复方案

### 修改配置

```toml
# configs/flashloan-dryrun.toml

# 修改前
query_interval_ms = 200

# 修改后
query_interval_ms = 5000  # 5秒间隔
```

### 新的查询频率

```
每轮: 4次API调用
间隔: 5秒
频率: 0.2轮/秒
总QPS: 0.8次/秒
每分钟: 48次 ✅

对比限制:
  48次/分钟 < 60次/分钟 = 安全！✅
  预留20%缓冲 = 不会触发429
```

---

## 📊 预期效果

| 指标 | 优化前(200ms) | 优化后(5000ms) | 提升 |
|------|--------------|---------------|------|
| **每分钟请求** | 1,200 | 48 | 降低96% |
| **vs API限制** | 超限20倍 ❌ | 低于限制 ✅ | 合规 |
| **成功率** | 3% | 95-99% | **提升30倍** |
| **429错误** | 频繁 | 极少/无 | 消除 |
| **机会/小时** | 0-5 | 10-50 | **提升5-10倍** |

---

## 🎯 为什么96%失败现在解释清楚了

### 完整的失败链路

```
1. Bot发送请求（20次/秒）
   ↓
2. Jupiter检测到超限（>1次/秒）
   ↓
3. 返回 429 Too Many Requests
   ↓
4. axios捕获错误
   ↓
5. 统计为"无路由"或"失败"
   ↓
6. 96%失败率
```

### 为什么测试时100%成功？

```
测试脚本:
  - 间隔500ms（每个查询之间）
  - 总共8次查询
  - 耗时约4秒
  - 频率: 8次/4秒 = 2次/秒 ✅ (虽然也超限，但短时间内可以)

Bot运行:
  - 间隔200ms（持续运行）
  - 每分钟1200次
  - 持续触发429
  - 频率: 20次/秒 ❌ (持续超限20倍)
```

---

## 🔬 Jupiter API速率限制详情

### Lite API（当前使用）

```
API: https://lite-api.jup.ag/swap/v1/quote
限制: 60次 / 60秒（滑动窗口）
窗口: 60秒
API Key: 不需要
费用: 免费
适用: 轻量级应用、测试
```

### Pro API（您已有Key）

```
API: https://api.jup.ag/swap/v1/quote
API Key: 3cf45ad3-8dfe-4c2d-86b2-11e45a4a275b
限制: 
  - Pro I: 600次/分钟 (10次/秒)
  - Pro II: 3,000次/分钟 (50次/秒)
  - Pro III: 6,000次/分钟 (100次/秒)
窗口: 10秒
费用: 按月付费
```

### Ultra API（推荐）

```
API: https://lite-api.jup.ag/ultra/v1/order
限制: 50次/10秒（基础）+ 动态扩展
窗口: 10秒
API Key: 不需要（Lite版本）
费用: 免费
特点: iris路由器，测试100%成功
```

---

## 🚀 三步修复计划

### ✅ 步骤1: 已完成配置修改

```toml
query_interval_ms = 5000  # 已修改
```

### 步骤2: 重新编译并运行

```bash
# 停止当前运行的bot（如果有）
# Ctrl+C

# 重新编译
pnpm run build

# 启动
pnpm run flashloan-dryrun
```

### 步骤3: 验证修复

**等待第10轮统计（约50秒）**

**预期看到**:
```
[Worker 0] 📊 Success Rate:          95-99% ✅
[Worker 0] 📊 Failure Rate:          1-5% ✅
[Worker 0] 📊 No Route Rate:         1-5% ✅
[Worker 0] 📊 Opportunities found:   5-15
```

**如果成功率仍 < 80%**:
- 考虑升级到Pro API (600次/分钟)
- 或切换到Ultra API

---

## 📈 升级路径

### 当前: Lite API (5秒间隔)

```
速率: 48次/分钟
成功率: 95-99%
机会/小时: 10-50
状态: ✅ 稳定，但慢
```

### 选项A: 升级Pro API

```
速率: 600次/分钟（Pro I）
间隔: 可缩短到400ms
机会/小时: 100-500
成本: 需付费
```

**修改代码**:
```typescript
// packages/jupiter-bot/src/workers/query-worker.ts:244,337
`https://api.jup.ag/swap/v1/quote?${paramsOut}`
// + 添加 X-API-Key header
```

### 选项B: 切换Ultra API

```
速率: 120次/分钟（基础）
间隔: 可缩短到2000ms
机会/小时: 50-200
成本: 免费
```

**修改代码**:
```typescript
`https://lite-api.jup.ag/ultra/v1/order?${paramsOut}`
// 数据字段调整
```

---

## 📝 关键洞察

### 1. 为什么之前的优化没效果？

```
200ms → 仍超限20倍
80ms → 超限150倍
3 Workers → 超限60倍

只有降到5000ms才符合Lite API限制！
```

### 2. 为什么Single Test成功但Bot失败？

```
测试: 短时间爆发，API宽容
Bot: 持续超限，触发限流保护
```

### 3. 96%失败不是代码Bug

```
✅ 代码逻辑正确
✅ 网络连接正常
✅ API端点可用
❌ 查询频率超限20倍 ← 真正原因
```

---

## ✅ 总结

### 根本原因

**速率限制超限20倍，导致96%请求被拒绝（429错误）**

### 修复方案

**将查询间隔从200ms增加到5000ms**

### 预期效果

**成功率从3%提升到95-99%（提升30倍）**

### 后续优化

**考虑升级到Pro API或Ultra API以提升查询频率**

---

**修复时间**: 2025-10-24 00:00  
**状态**: ✅ 配置已修改  
**下一步**: 重新编译并测试

