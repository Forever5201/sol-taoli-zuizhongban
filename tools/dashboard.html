<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>闪电贷机会生命周期研究仪表板</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <style>
    [x-cloak] { display: none !important; }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .table-row:hover {
      background-color: rgba(102, 126, 234, 0.1);
    }
    
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
    }
  </style>
</head>
<body class="p-6">
  <div x-data="dashboard()" x-init="init()" x-cloak class="max-w-7xl mx-auto">
    
    <!-- 顶部导航 -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-4xl font-bold text-white mb-2">📊 闪电贷机会生命周期研究</h1>
          <p class="text-purple-200">实时数据分析与可视化仪表板</p>
        </div>
        <div class="flex gap-4">
          <button @click="refreshData()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-purple-50 transition-all shadow-lg">
            <span x-show="!loading">🔄 刷新数据</span>
            <span x-show="loading">⏳ 加载中...</span>
          </button>
          <a href="/api/export/csv" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-all shadow-lg">
            📥 导出CSV
          </a>
        </div>
      </div>
    </div>

    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- 总机会数 -->
      <div class="card rounded-xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-600 text-sm font-medium">总机会数</span>
          <span class="text-2xl">📊</span>
        </div>
        <div class="stat-number" x-text="stats.total"></div>
        <div class="text-xs text-gray-500 mt-2">从第一次发现开始</div>
      </div>

      <!-- 通过验证 -->
      <div class="card rounded-xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-600 text-sm font-medium">通过验证</span>
          <span class="text-2xl">✅</span>
        </div>
        <div class="flex items-baseline gap-2">
          <div class="stat-number" x-text="stats.passed"></div>
          <div class="text-lg text-green-600 font-semibold" x-text="'(' + stats.passRate + '%)'"></div>
        </div>
        <div class="text-xs text-gray-500 mt-2">通过率</div>
      </div>

      <!-- 平均存活时间 -->
      <div class="card rounded-xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-600 text-sm font-medium">平均存活</span>
          <span class="text-2xl">⏱️</span>
        </div>
        <div class="flex items-baseline gap-2">
          <div class="stat-number" x-text="stats.avgLifetime"></div>
          <div class="text-lg text-gray-600">ms</div>
        </div>
        <div class="text-xs text-gray-500 mt-2">机会存在周期</div>
      </div>

      <!-- 平均衰减率 -->
      <div class="card rounded-xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-600 text-sm font-medium">平均衰减</span>
          <span class="text-2xl">📉</span>
        </div>
        <div class="flex items-baseline gap-2">
          <div class="stat-number" x-text="stats.avgDecay"></div>
          <div class="text-lg text-gray-600">%</div>
        </div>
        <div class="text-xs text-gray-500 mt-2">利润衰减率</div>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- 存活时间分布 -->
      <div class="card rounded-xl p-6 shadow-xl">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">⏱️ 机会存活时间分布</h3>
        <div style="height: 300px; position: relative;">
          <canvas id="lifetimeChart"></canvas>
        </div>
      </div>

      <!-- DEX使用统计 -->
      <div class="card rounded-xl p-6 shadow-xl">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">🏦 DEX使用分布</h3>
        <div style="height: 300px; position: relative;">
          <canvas id="dexChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 利润衰减散点图 -->
    <div class="card rounded-xl p-6 shadow-xl mb-8">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 利润衰减率 vs 存活时间</h3>
      <div style="height: 350px; position: relative;">
        <canvas id="decayChart"></canvas>
      </div>
    </div>

    <!-- 数据表格 -->
    <div class="card rounded-xl p-6 shadow-xl">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-800">📋 机会验证记录</h3>
        <div class="flex gap-4 items-center">
          <select x-model="filter" @change="filterValidations()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            <option value="all">全部</option>
            <option value="passed">✅ 通过验证</option>
            <option value="failed">❌ 未通过</option>
          </select>
          <input type="text" x-model="searchTerm" @input="searchValidations()" placeholder="搜索..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b-2 border-gray-200">
              <th class="text-left p-3 text-sm font-semibold text-gray-700">ID</th>
              <th class="text-left p-3 text-sm font-semibold text-gray-700">发现时间</th>
              <th class="text-right p-3 text-sm font-semibold text-gray-700">首次利润</th>
              <th class="text-right p-3 text-sm font-semibold text-gray-700">验证利润</th>
              <th class="text-right p-3 text-sm font-semibold text-gray-700">衰减率</th>
              <th class="text-right p-3 text-sm font-semibold text-gray-700">存活时间</th>
              <th class="text-center p-3 text-sm font-semibold text-gray-700">状态</th>
              <th class="text-center p-3 text-sm font-semibold text-gray-700">桥接</th>
              <th class="text-center p-3 text-sm font-semibold text-gray-700">操作</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="item in displayedValidations" :key="item.id">
              <tr class="table-row border-b border-gray-100 cursor-pointer" @click="showDetail(item)">
                <td class="p-3 text-sm text-gray-600" x-text="item.id"></td>
                <td class="p-3 text-sm text-gray-600" x-text="formatDate(item.firstDetectedAt)"></td>
                <td class="p-3 text-sm text-right font-mono text-gray-800" x-text="formatProfit(item.firstProfit)"></td>
                <td class="p-3 text-sm text-right font-mono text-gray-800" x-text="formatProfit(item.secondProfit)"></td>
                <td class="p-3 text-sm text-right" :class="getDecayColor(item)" x-text="calculateDecay(item) + '%'"></td>
                <td class="p-3 text-sm text-right font-mono text-gray-700" x-text="item.validationDelayMs + 'ms'"></td>
                <td class="p-3 text-center">
                  <span x-show="item.stillExists" class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">✅ 通过</span>
                  <span x-show="!item.stillExists" class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">❌ 失败</span>
                </td>
                <td class="p-3 text-center text-sm text-gray-600" x-text="getHops(item) + '跳'"></td>
                <td class="p-3 text-center">
                  <button @click.stop="showDetail(item)" class="text-purple-600 hover:text-purple-800 font-semibold text-sm">查看</button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- 分页 -->
      <div class="flex items-center justify-between mt-6">
        <div class="text-sm text-gray-600">
          显示 <span x-text="displayedValidations.length"></span> 条，共 <span x-text="validations.length"></span> 条记录
        </div>
        <div class="flex gap-2">
          <button @click="prevPage()" :disabled="currentPage === 1" class="px-4 py-2 bg-gray-200 rounded-lg disabled:opacity-50">上一页</button>
          <span class="px-4 py-2 text-gray-700">第 <span x-text="currentPage"></span> 页</span>
          <button @click="nextPage()" :disabled="currentPage * pageSize >= validations.length" class="px-4 py-2 bg-gray-200 rounded-lg disabled:opacity-50">下一页</button>
        </div>
      </div>
    </div>

    <!-- 详情模态框 -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" @click="closeDetail()">
      <div @click.stop class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
          <h3 class="text-2xl font-bold text-gray-800">机会详情 #<span x-text="selectedItem?.id"></span></h3>
          <button @click="closeDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
        </div>
        
        <div x-show="selectedItem" class="p-6 space-y-6">
          <!-- 基础信息 -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-purple-50 p-4 rounded-lg">
              <div class="text-sm text-gray-600 mb-1">💰 首次利润</div>
              <div class="text-2xl font-bold text-purple-700" x-text="formatProfit(selectedItem?.firstProfit)"></div>
              <div class="text-xs text-gray-500 mt-1" x-text="'ROI: ' + (selectedItem?.firstRoi * 100).toFixed(2) + '%'"></div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <div class="text-sm text-gray-600 mb-1">💎 验证利润</div>
              <div class="text-2xl font-bold text-green-700" x-text="formatProfit(selectedItem?.secondProfit)"></div>
              <div class="text-xs text-gray-500 mt-1" x-text="selectedItem?.secondRoi ? 'ROI: ' + (selectedItem.secondRoi * 100).toFixed(2) + '%' : 'N/A'"></div>
            </div>
          </div>

          <!-- 延迟分析 -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-3">⏱️ 延迟分析</h4>
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div>
                <div class="text-gray-600">机会存活</div>
                <div class="text-lg font-bold text-gray-800" x-text="selectedItem?.validationDelayMs + 'ms'"></div>
              </div>
              <div>
                <div class="text-gray-600">首次查询</div>
                <div class="text-lg font-bold text-gray-800" x-text="((selectedItem?.firstOutboundMs || 0) + (selectedItem?.firstReturnMs || 0)) + 'ms'"></div>
              </div>
              <div>
                <div class="text-gray-600">验证查询</div>
                <div class="text-lg font-bold text-gray-800" x-text="((selectedItem?.secondOutboundMs || 0) + (selectedItem?.secondReturnMs || 0)) + 'ms'"></div>
              </div>
            </div>
          </div>

          <!-- 路由信息 -->
          <div x-show="selectedItem?.opportunity?.metadata?.routeInfo" class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-3">🔀 路由信息</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">桥接代币:</span>
                <span class="font-semibold" x-text="selectedItem?.opportunity?.bridgeToken || 'Unknown'"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">总跳数:</span>
                <span class="font-semibold" x-text="selectedItem?.opportunity?.metadata?.routeInfo?.totalHops || 0"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">使用DEX:</span>
                <span class="font-semibold" x-text="(selectedItem?.opportunity?.metadata?.routeInfo?.dexes || []).join(', ')"></span>
              </div>
            </div>
          </div>

          <!-- 元数据 -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-3">📄 完整元数据</h4>
            <pre class="text-xs bg-gray-800 text-green-400 p-4 rounded overflow-x-auto" x-text="JSON.stringify(selectedItem?.opportunity?.metadata, null, 2)"></pre>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    function dashboard() {
      return {
        loading: false,
        stats: {
          total: 0,
          passed: 0,
          passRate: '0',
          avgLifetime: 0,
          avgDecay: '0'
        },
        validations: [],
        displayedValidations: [],
        currentPage: 1,
        pageSize: 20,
        filter: 'all',
        searchTerm: '',
        showModal: false,
        selectedItem: null,
        charts: {},

        async init() {
          await this.refreshData();
        },

        async refreshData() {
          this.loading = true;
          try {
            await Promise.all([
              this.loadStats(),
              this.loadValidations(),
              this.loadCharts()
            ]);
          } catch (error) {
            console.error('Error loading data:', error);
            alert('加载数据失败: ' + error.message);
          } finally {
            this.loading = false;
          }
        },

        async loadStats() {
          const response = await fetch('/api/stats');
          this.stats = await response.json();
        },

        async loadValidations() {
          const response = await fetch('/api/validations?limit=1000');
          const data = await response.json();
          this.validations = data.data;
          this.updateDisplayedValidations();
        },

        async loadCharts() {
          await Promise.all([
            this.loadLifetimeChart(),
            this.loadDecayChart(),
            this.loadDexChart()
          ]);
        },

        async loadLifetimeChart() {
          const response = await fetch('/api/charts/lifetime');
          const data = await response.json();
          
          const ctx = document.getElementById('lifetimeChart');
          if (this.charts.lifetime) this.charts.lifetime.destroy();
          
          this.charts.lifetime = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [{
                label: '机会数量',
                data: data.data,
                backgroundColor: [
                  'rgba(34, 197, 94, 0.7)',
                  'rgba(59, 130, 246, 0.7)',
                  'rgba(234, 179, 8, 0.7)',
                  'rgba(249, 115, 22, 0.7)',
                  'rgba(239, 68, 68, 0.7)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        },

        async loadDecayChart() {
          const response = await fetch('/api/charts/decay');
          const data = await response.json();
          
          const ctx = document.getElementById('decayChart');
          if (this.charts.decay) this.charts.decay.destroy();
          
          this.charts.decay = new Chart(ctx, {
            type: 'scatter',
            data: {
              datasets: [{
                label: '✅ 通过验证',
                data: data.passed,
                backgroundColor: 'rgba(34, 197, 94, 0.6)'
              }, {
                label: '❌ 未通过',
                data: data.failed,
                backgroundColor: 'rgba(239, 68, 68, 0.6)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { title: { display: true, text: '存活时间 (ms)' } },
                y: { title: { display: true, text: '衰减率 (%)' } }
              }
            }
          });
        },

        async loadDexChart() {
          const response = await fetch('/api/charts/dex');
          const data = await response.json();
          
          const ctx = document.getElementById('dexChart');
          if (this.charts.dex) this.charts.dex.destroy();
          
          this.charts.dex = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: data.labels,
              datasets: [{
                data: data.data,
                backgroundColor: [
                  '#667eea', '#764ba2', '#f093fb', '#4facfe',
                  '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        },

        filterValidations() {
          this.currentPage = 1;
          this.updateDisplayedValidations();
        },

        searchValidations() {
          this.currentPage = 1;
          this.updateDisplayedValidations();
        },

        updateDisplayedValidations() {
          let filtered = this.validations;
          
          if (this.filter === 'passed') {
            filtered = filtered.filter(v => v.stillExists);
          } else if (this.filter === 'failed') {
            filtered = filtered.filter(v => !v.stillExists);
          }
          
          if (this.searchTerm) {
            const term = this.searchTerm.toLowerCase();
            filtered = filtered.filter(v => 
              v.id.toString().includes(term) ||
              v.opportunity?.bridgeToken?.toLowerCase().includes(term)
            );
          }
          
          const start = (this.currentPage - 1) * this.pageSize;
          const end = start + this.pageSize;
          this.displayedValidations = filtered.slice(start, end);
        },

        prevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.updateDisplayedValidations();
          }
        },

        nextPage() {
          if (this.currentPage * this.pageSize < this.validations.length) {
            this.currentPage++;
            this.updateDisplayedValidations();
          }
        },

        showDetail(item) {
          this.selectedItem = item;
          this.showModal = true;
        },

        closeDetail() {
          this.showModal = false;
          this.selectedItem = null;
        },

        formatDate(date) {
          return new Date(date).toLocaleString('zh-CN');
        },

        formatProfit(profit) {
          if (!profit) return '0.000000 SOL';
          return (Number(profit) / 1e9).toFixed(6) + ' SOL';
        },

        calculateDecay(item) {
          if (!item.secondProfit || item.firstProfit === 0) return '100.00';
          const decay = ((Number(item.firstProfit) - Number(item.secondProfit)) / Number(item.firstProfit)) * 100;
          return decay.toFixed(2);
        },

        getDecayColor(item) {
          const decay = parseFloat(this.calculateDecay(item));
          if (decay < 20) return 'text-green-600 font-semibold';
          if (decay < 50) return 'text-yellow-600 font-semibold';
          return 'text-red-600 font-semibold';
        },

        getHops(item) {
          return item.opportunity?.metadata?.routeInfo?.totalHops || 0;
        }
      }
    }
  </script>
</body>
</html>

