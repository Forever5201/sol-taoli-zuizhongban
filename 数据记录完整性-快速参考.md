# æ•°æ®è®°å½•å®Œæ•´æ€§ - å¿«é€Ÿå‚è€ƒ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ–¹å¼1: Prisma Migrateï¼ˆæ¨èï¼‰
cd packages/core
pnpm prisma migrate dev --name add_latency_tracking_fields

# æ–¹å¼2: æ‰‹åŠ¨SQL
psql -h localhost -U solana_arb_user -d solana_arb_bot
\i æ•°æ®è®°å½•å®Œæ•´æ€§ä¿®å¤-è¿ç§»SQL.sql
```

### 2. é‡æ–°ç¼–è¯‘ä»£ç 

```bash
# å·²å®Œæˆï¼å¯ä»¥ç›´æ¥å¯åŠ¨Bot
pnpm run build  # âœ… ç¼–è¯‘æˆåŠŸ
```

### 3. éªŒè¯åŠŸèƒ½

```bash
# è¿è¡ŒéªŒè¯è„šæœ¬
.\verify-latency-tracking.bat

# æˆ–è€…æ‰‹åŠ¨
pnpm tsx verify-latency-tracking.ts
```

---

## ğŸ“Š å·²ä¿®å¤çš„é—®é¢˜æ€»ç»“

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| RPCæ¨¡æ‹Ÿå¤±è´¥è®°å½• | âŒ ç¼ºå¤± | âœ… å®Œæ•´è®°å½• |
| ä½™é¢ä¸è¶³åŸå›  | âŒ æœªçŸ¥ | âœ… è¯¦ç»†è®°å½• |
| ç¬¬ä¸€æ¬¡outboundå»¶è¿Ÿ | âš ï¸ ä»…æ—¥å¿— | âœ… æ•°æ®åº“ |
| ç¬¬ä¸€æ¬¡returnå»¶è¿Ÿ | âš ï¸ ä»…æ—¥å¿— | âœ… æ•°æ®åº“ |
| ç¬¬äºŒæ¬¡outboundå»¶è¿Ÿ | âŒ ç¼ºå¤± | âœ… æ•°æ®åº“ |
| ç¬¬äºŒæ¬¡returnå»¶è¿Ÿ | âŒ ç¼ºå¤± | âœ… æ•°æ®åº“ |

---

## ğŸ—„ï¸ æ–°å¢æ•°æ®åº“å­—æ®µ

```sql
ALTER TABLE opportunity_validations
ADD COLUMN first_outbound_ms INTEGER,   -- Workerå‘ç°æ—¶çš„å»ç¨‹å»¶è¿Ÿ
ADD COLUMN first_return_ms INTEGER,     -- Workerå‘ç°æ—¶çš„å›ç¨‹å»¶è¿Ÿ
ADD COLUMN second_outbound_ms INTEGER,  -- äºŒæ¬¡éªŒè¯çš„å»ç¨‹å»¶è¿Ÿ
ADD COLUMN second_return_ms INTEGER;    -- äºŒæ¬¡éªŒè¯çš„å›ç¨‹å»¶è¿Ÿ
```

---

## ğŸ“ˆ å¸¸ç”¨åˆ†æSQL

### æŸ¥çœ‹æœ€è¿‘çš„å»¶è¿Ÿæ•°æ®

```sql
SELECT 
    id,
    opportunity_id,
    first_outbound_ms,
    first_return_ms,
    second_outbound_ms,
    second_return_ms,
    validation_delay_ms,
    still_exists
FROM opportunity_validations
ORDER BY id DESC
LIMIT 10;
```

### å¯¹æ¯”Ultra API vs Lite APIå»¶è¿Ÿ

```sql
SELECT 
    'Ultra API (é¦–æ¬¡å‘ç°)' AS api_type,
    AVG(first_outbound_ms + first_return_ms) AS avg_total_ms,
    AVG(first_outbound_ms) AS avg_outbound_ms,
    AVG(first_return_ms) AS avg_return_ms
FROM opportunity_validations
WHERE first_outbound_ms IS NOT NULL

UNION ALL

SELECT 
    'Lite API (äºŒæ¬¡éªŒè¯)',
    AVG(second_outbound_ms + second_return_ms),
    AVG(second_outbound_ms),
    AVG(second_return_ms)
FROM opportunity_validations
WHERE second_outbound_ms IS NOT NULL;
```

### æŸ¥çœ‹RPCæ¨¡æ‹Ÿè¿‡æ»¤çš„åŸå› 

```sql
SELECT 
    filter_reason,
    COUNT(*) AS count,
    AVG(profit / 1e9) AS avg_profit_sol
FROM opportunities
WHERE status = 'FILTERED'
    AND filter_reason IS NOT NULL
GROUP BY filter_reason
ORDER BY count DESC;
```

---

## âœ… éªŒè¯æ¸…å•

è¿è¡ŒBotåï¼Œç¡®ä¿ï¼š

- [ ] `pnpm run build` ç¼–è¯‘æˆåŠŸ âœ…ï¼ˆå·²å®Œæˆï¼‰
- [ ] æ•°æ®åº“è¿ç§»æ‰§è¡ŒæˆåŠŸ
- [ ] `verify-latency-tracking.bat` è¿è¡Œæ— é”™è¯¯
- [ ] `opportunity_validations` è¡¨æœ‰4ä¸ªæ–°å­—æ®µ
- [ ] Botå¯åŠ¨åï¼Œæ–°è®°å½•è‡ªåŠ¨å¡«å……å»¶è¿Ÿæ•°æ®
- [ ] ä½™é¢ä¸è¶³æ—¶ï¼Œ`filter_reason` ä¸ä¸ºç©º

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜1: Prismaè¿ç§»å¤±è´¥

**é”™è¯¯**ï¼š`Authentication failed`

**è§£å†³**ï¼š
1. æ£€æŸ¥`.env`æ–‡ä»¶ä¸­çš„`DATABASE_URL`
2. ç¡®ä¿PostgreSQLæœåŠ¡æ­£åœ¨è¿è¡Œ
3. ä½¿ç”¨æ–¹å¼2ï¼ˆæ‰‹åŠ¨SQLï¼‰æ‰§è¡Œè¿ç§»

### é—®é¢˜2: å»¶è¿Ÿå­—æ®µä¸ºNULL

**åŸå› **ï¼šBotä½¿ç”¨æ—§ä»£ç è¿è¡Œ

**è§£å†³**ï¼š
1. é‡æ–°ç¼–è¯‘ï¼š`pnpm run build`
2. é‡å¯Bot
3. è§‚å¯Ÿæ–°è®°å½•

### é—®é¢˜3: ç¼–è¯‘é”™è¯¯

**é”™è¯¯**ï¼š`Cannot find name 'outboundLatency'`

**è§£å†³**ï¼šå·²ä¿®å¤ï¼é‡æ–°æ‰§è¡Œ`pnpm run build`

---

## ğŸ¯ æœªæ¥åˆ†æå»ºè®®

æ”¶é›†1å°æ—¶æ•°æ®åï¼Œæ‚¨å¯ä»¥ï¼š

1. **å»¶è¿Ÿè¶‹åŠ¿åˆ†æ**ï¼š
   - Ultra APIæ˜¯å¦ç¨³å®šï¼Ÿ
   - é«˜å³°æ—¶æ®µå»¶è¿Ÿæ˜¯å¦å¢åŠ ï¼Ÿ

2. **APIå¯¹æ¯”**ï¼š
   - Ultra API vs Lite APIï¼Œå“ªä¸ªæ›´å¿«ï¼Ÿ
   - æ˜¯å¦å€¼å¾—åˆ‡æ¢äºŒæ¬¡éªŒè¯åˆ°Ultra APIï¼Ÿ

3. **æœºä¼šå­˜æ´»åˆ†æ**ï¼š
   - é«˜å»¶è¿Ÿæ˜¯å¦å¯¼è‡´æœºä¼šæ¶ˆå¤±ï¼Ÿ
   - æœ€ä¼˜å»¶è¿ŸèŒƒå›´æ˜¯å¤šå°‘ï¼Ÿ

4. **æˆæœ¬æ•ˆç›Šåˆ†æ**ï¼š
   - RPCè¿‡æ»¤èŠ‚çœå¤šå°‘Gasï¼Ÿ
   - ä½™é¢ä¸è¶³çš„é¢‘ç‡ï¼Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-23  
**ç›¸å…³æ–‡æ¡£**ï¼š`æ•°æ®è®°å½•å®Œæ•´æ€§ä¿®å¤-å®ŒæˆæŠ¥å‘Š.md`

