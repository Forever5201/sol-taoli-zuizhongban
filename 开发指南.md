# 套利机器人本地开发指南

## 🎉 恭喜！您的开发环境已就绪

所有核心功能测试通过，可以开始开发了！

---

## 📁 项目结构

```
dex-sol/
├── packages/
│   ├── core/              # 核心功能（已编译✅）
│   │   ├── src/
│   │   │   ├── solana/    # Solana集成
│   │   │   ├── economics/ # 经济模型
│   │   │   ├── config/    # 配置系统（含代理）
│   │   │   └── logger/    # 日志系统
│   │   └── dist/          # 编译输出
│   └── onchain-bot/       # 链上机器人（已编译✅）
│       └── src/executors/ # Jito执行器
│
├── configs/               # 配置文件
│   ├── devnet-test.toml  # Devnet测试配置✅
│   └── global.toml       # 全局配置
│
├── keypairs/             # 测试钱包
│   └── devnet-test-wallet.json  # 已生成✅
│
├── examples/             # 示例代码
│   ├── test-jupiter-swap.ts    # Jupiter测试
│   └── economics-demo.ts       # 经济模型演示
│
├── scripts/              # 工具脚本
│   └── generate-keypair.js     # 钱包生成
│
├── test-local-complete.js      # 本地完整测试✅
├── .env                         # 环境变量（代理配置）✅
└── package.json
```

---

## 🔧 常用命令

### **开发命令**

```bash
# 编译代码
npm run build

# 运行本地测试
node test-local-complete.js

# 生成新钱包
node scripts/generate-keypair.js

# 清理编译产物
npm run clean
```

### **测试命令**

```bash
# 模拟测试（无需网络）
node test-local-complete.js  # ✅ 已通过

# 网络诊断
node test-network-simple.js

# Jupiter测试（需要网络）
node test-jupiter-with-proxy.js
```

---

## 📝 开发工作流

### **典型开发流程：**

1. **修改代码**
   ```bash
   # 编辑 packages/core/src/ 或 packages/onchain-bot/src/
   code packages/core/src/solana/jupiter-swap.ts
   ```

2. **编译**
   ```bash
   npm run build
   ```

3. **测试**
   ```bash
   node test-local-complete.js
   ```

4. **调试**
   - 查看测试输出
   - 修改代码
   - 重新编译和测试

---

## 🎨 添加新策略

### **示例：添加简单套利策略**

创建文件：`packages/onchain-bot/src/strategies/simple-arb.ts`

```typescript
/**
 * 简单套利策略
 */

import { PublicKey } from '@solana/web3.js';

export interface ArbitrageOpportunity {
  tokenA: PublicKey;
  tokenB: PublicKey;
  profitSOL: number;
  route: string[];
}

export class SimpleArbitrageStrategy {
  private minProfitSOL: number;

  constructor(minProfitSOL: number = 0.01) {
    this.minProfitSOL = minProfitSOL;
  }

  /**
   * 检测套利机会
   */
  async detectOpportunities(): Promise<ArbitrageOpportunity[]> {
    // TODO: 实现您的策略逻辑
    const opportunities: ArbitrageOpportunity[] = [];
    
    // 示例：检测价格差异
    // ...
    
    return opportunities;
  }

  /**
   * 评估机会是否值得执行
   */
  isWorthExecuting(opportunity: ArbitrageOpportunity): boolean {
    return opportunity.profitSOL >= this.minProfitSOL;
  }
}
```

然后编译测试：
```bash
npm run build
node test-local-complete.js
```

---

## 🧪 模拟测试技巧

### **1. 使用Mock数据**

```javascript
// 模拟Jupiter Quote
const mockQuote = {
  inputMint: 'SOL',
  outputMint: 'USDC',
  inAmount: '100000000',
  outAmount: '18500000',
  priceImpactPct: '0.15',
};

// 测试利润计算
const profit = calculateProfit(mockQuote);
console.log(`预期利润: ${profit} SOL`);
```

### **2. 测试边界条件**

```javascript
// 测试最小利润阈值
const testCases = [
  { profit: 0.005, shouldExecute: false },
  { profit: 0.01, shouldExecute: true },
  { profit: 0.05, shouldExecute: true },
];

for (const test of testCases) {
  const result = isWorthExecuting(test.profit);
  console.log(`Profit ${test.profit}: ${result === test.shouldExecute ? '✅' : '❌'}`);
}
```

### **3. 测试风险控制**

```javascript
// 测试滑点保护
const riskChecks = {
  slippage: 0.5,  // 0.5%
  maxSlippage: 2.0,  // 2.0%
};

const isRiskAcceptable = riskChecks.slippage <= riskChecks.maxSlippage;
console.log(`风险检查: ${isRiskAcceptable ? '✅ 通过' : '❌ 拒绝'}`);
```

---

## 🔍 调试技巧

### **1. 添加日志**

```typescript
import { logger } from '../logger';

const swapLogger = logger.child({ module: 'MyStrategy' });

swapLogger.info('开始检测套利机会');
swapLogger.debug('输入参数', { amount, tokenPair });
swapLogger.warn('利润低于阈值', { profit, threshold });
swapLogger.error('执行失败', error);
```

### **2. 使用调试器**

```bash
# VSCode调试配置
# 按F5启动调试
```

### **3. 单元测试**

创建 `packages/core/src/__tests__/profit-calculator.test.ts`：

```typescript
import { calculateProfit } from '../economics/profit-analyzer';

describe('Profit Calculator', () => {
  test('应该正确计算净利润', () => {
    const result = calculateProfit({
      inputAmount: 0.1,
      outputAmount: 0.105,
      fees: 0.00015,
    });
    
    expect(result).toBeCloseTo(0.00485, 5);
  });
});
```

---

## 📊 性能优化建议

### **1. 批量处理**

```typescript
// 批量获取多个池子的价格
const prices = await Promise.all([
  getPoolPrice(pool1),
  getPoolPrice(pool2),
  getPoolPrice(pool3),
]);
```

### **2. 缓存机制**

```typescript
const cache = new Map<string, CachedData>();

function getCachedPrice(poolId: string): number | null {
  const cached = cache.get(poolId);
  if (cached && Date.now() - cached.timestamp < 1000) {
    return cached.price;
  }
  return null;
}
```

### **3. 并发控制**

```typescript
import PQueue from 'p-queue';

const queue = new PQueue({ concurrency: 10 });

// 限制并发请求数
await queue.add(() => fetchPoolData(poolId));
```

---

## 🚀 下一步计划

### **阶段1: 本地开发（当前）✅**
- [x] 环境搭建
- [x] 核心功能验证
- [ ] 策略开发
- [ ] 单元测试

### **阶段2: 本地真实测试**
- [ ] 安装Solana CLI
- [ ] 启动本地测试网
- [ ] 真实交易测试

### **阶段3: Devnet测试**
- [ ] 配置Devnet连接
- [ ] 小金额测试
- [ ] 性能优化

### **阶段4: 生产部署**
- [ ] VPS部署
- [ ] Mainnet测试
- [ ] 监控和告警

---

## 💡 常见问题

### Q: 如何添加新的DEX支持？

A: 在 `packages/onchain-bot/src/parsers/` 添加新的解析器：

```typescript
// new-dex.ts
export class NewDexParser {
  parsePoolData(accountData: Buffer): PoolInfo {
    // 实现解析逻辑
  }
}
```

### Q: 如何调整利润阈值？

A: 修改配置文件 `configs/devnet-test.toml`：

```toml
[trading]
min_profit_sol = 0.001  # 改为您期望的阈值
```

### Q: 如何查看详细日志？

A: 设置日志级别为debug：

```bash
# .env文件
LOG_LEVEL=debug
```

---

## 📚 资源链接

- [Solana文档](https://docs.solana.com/)
- [Jupiter API文档](https://station.jup.ag/docs)
- [Jito文档](https://jito-labs.gitbook.io/)
- [TypeScript文档](https://www.typescriptlang.org/docs/)

---

## ✅ 检查清单

开始开发前确认：

- [x] 代码编译成功
- [x] 本地测试通过
- [x] 理解项目结构
- [ ] 阅读核心代码
- [ ] 设计您的策略
- [ ] 开始编码！

---

祝开发顺利！🚀
