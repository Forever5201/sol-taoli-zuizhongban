# ğŸ—„ï¸ æ•°æ®åº“è®°å½•åˆ†ææŠ¥å‘Š

## ğŸ“‹ é…ç½®æ£€æŸ¥

### æ•°æ®åº“é…ç½®çŠ¶æ€

ä»é…ç½®æ–‡ä»¶ `configs/flashloan-dryrun.toml`ï¼š
```toml
[database]
enabled = true  âœ…
url = "${DATABASE_URL}"
```

ä»æ—¥å¿—ï¼š
```
{"level":30,"time":1761229550600,"pid":31064,"hostname":"yuanwen","module":"FlashloanBot","msg":"Loading config from: configs/flashloan-dryrun.toml"}
```

**ç»“è®º**: âœ… æ•°æ®åº“åŠŸèƒ½å·²å¯ç”¨

---

## ğŸ” æ•°æ®åº“è®°å½•é€»è¾‘åˆ†æ

### 1ï¸âƒ£ è®°å½•è§¦å‘ç‚¹

#### A. æœºä¼šé¦–æ¬¡å‘ç°ï¼ˆç”± Bot ä¸»ç¨‹åºè®°å½•ï¼‰

```typescript
// packages/jupiter-bot/src/flashloan-bot.ts Line 781-791

if (this.config.database?.enabled) {
  try {
    opportunityId = await databaseRecorder.recordOpportunity({
      inputMint: opportunity.inputMint.toBase58(),
      outputMint: opportunity.outputMint.toBase58(),
      firstProfit: BigInt(opportunity.profit),
      firstRoi: opportunity.profit / opportunity.inputAmount,
      firstDetectedAt: firstDetectedAt,
      bridgeToken: opportunity.bridgeToken || null,
    });
  } catch (error) {
    logger.warn('âš ï¸ Failed to record opportunity (non-blocking):', error);
  }
}
```

**è§¦å‘æ¡ä»¶**: 
- âœ… `database.enabled = true`
- âœ… æœºä¼šè¢« Worker å‘é€åˆ°ä¸»ç¨‹åºï¼ˆå·²è¶…è¿‡é˜ˆå€¼ï¼‰
- âœ… åœ¨ `handleOpportunity` å‡½æ•°è¢«è°ƒç”¨æ—¶

#### B. äºŒæ¬¡éªŒè¯ç»“æœï¼ˆç”± Bot ä¸»ç¨‹åºè®°å½•ï¼‰

```typescript
// packages/jupiter-bot/src/flashloan-bot.ts Line 815-831

if (this.config.database?.enabled && opportunityId) {
  try {
    await databaseRecorder.recordOpportunityValidation({
      opportunityId,
      firstDetectedAt,
      firstProfit,
      firstRoi,
      secondCheckedAt: new Date(),
      stillExists: revalidation.stillExists,
      secondProfit: revalidation.stillExists ? BigInt(revalidation.secondProfit) : undefined,
      secondRoi: revalidation.stillExists ? revalidation.secondRoi : undefined,
      validationDelayMs: revalidation.delayMs,
    });
  } catch (error) {
    logger.warn('âš ï¸ Failed to record validation (non-blocking):', error);
  }
}
```

**è§¦å‘æ¡ä»¶**:
- âœ… `database.enabled = true`
- âœ… `opportunityId` å­˜åœ¨ï¼ˆé¦–æ¬¡è®°å½•æˆåŠŸï¼‰
- âœ… äºŒæ¬¡éªŒè¯å®Œæˆ

#### C. æœºä¼šè¢«è¿‡æ»¤ï¼ˆç”± Bot ä¸»ç¨‹åºè®°å½•ï¼‰

```typescript
// packages/jupiter-bot/src/flashloan-bot.ts Line 836-845

if (this.config.database?.enabled && opportunityId) {
  try {
    await databaseRecorder.markOpportunityFiltered(
      opportunityId,
      `Expired on re-validation: profit dropped to ${(revalidation.secondProfit / LAMPORTS_PER_SOL).toFixed(6)} SOL`
    );
  } catch (error) {
    logger.warn('âš ï¸ Failed to mark filtered (non-blocking):', error);
  }
}
```

**è§¦å‘æ¡ä»¶**:
- âœ… `database.enabled = true`
- âœ… `opportunityId` å­˜åœ¨
- âœ… äºŒæ¬¡éªŒè¯å¤±è´¥ï¼ˆæœºä¼šæ¶ˆå¤±ï¼‰

---

## ğŸ“Š ä»æ—¥å¿—åˆ†æè®°å½•æƒ…å†µ

### è§‚å¯Ÿçš„æœºä¼š

#### æœºä¼š #1
```
ğŸ¯ [Worker 0] Opportunity #1:
   Path: So11... â†’ USDT â†’ So11...
   Profit: 0.002375 SOL (0.02%)
   Query time: 369ms

{"level":30,"time":1761229556211,"pid":31064,"hostname":"yuanwen","module":"FlashloanBot","msg":"ğŸ”„ Performing immediate re-validation..."}
{"level":30,"time":1761229556452,"pid":31064,"hostname":"yuanwen","module":"FlashloanBot","msg":"ğŸ“Š Validation result: stillExists=false, profit=-0.001438 SOL (-0.01%), delay=241ms"}
{"level":40,"time":1761229556452,"pid":31064,"hostname":"yuanwen","module":"FlashloanBot","msg":"â±ï¸ Opportunity expired after 241mms, skipping execution"}
```

**åº”è¯¥è®°å½•çš„æ•°æ®**:

| è¡¨ | å­—æ®µ | å€¼ |
|----|----|-----|
| **opportunities** | | |
| | input_mint | `So11111111111111111111111111111111111111112` (SOL) |
| | output_mint | `Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB` (USDT) |
| | first_profit | `2375322` lamports |
| | first_roi | `0.0002375322` (0.02%) |
| | first_detected_at | `2025-10-23 22:25:56.211` |
| | status | `filtered` (å› ä¸ºäºŒæ¬¡éªŒè¯å¤±è´¥) |
| **opportunity_validations** | | |
| | first_profit | `2375322` lamports |
| | second_profit | `-1438000` lamports (å˜ä¸ºè´Ÿæ•°) |
| | still_exists | `false` âŒ |
| | validation_delay_ms | `241` ms |

#### æœºä¼š #2
```
ğŸ¯ [Worker 0] Opportunity #2:
   Path: So11... â†’ USDT â†’ So11...
   Profit: 0.002239 SOL (0.02%)
   Query time: 401ms

{"level":30,"time":1761229564672,"pid":31064,"hostname":"yuanwen","module":"FlashloanBot","msg":"ğŸ”„ Performing immediate re-validation..."}
{"level":30,"time":1761229564928,"pid":31064,"hostname":"yuanwen","module":"FlashloanBot","msg":"ğŸ“Š Validation result: stillExists=false, profit=-0.000134 SOL (-0.00%), delay=256ms"}
{"level":40,"time":1761229564928,"pid":31064,"hostname":"yuanwen","module":"FlashloanBot","msg":"â±ï¸ Opportunity expired after 256mms, skipping execution"}
```

**åº”è¯¥è®°å½•çš„æ•°æ®**:

| è¡¨ | å­—æ®µ | å€¼ |
|----|----|-----|
| **opportunities** | | |
| | first_profit | `2238802` lamports (0.002239 SOL) |
| | first_roi | `0.0002238802` (0.02%) |
| | first_detected_at | `2025-10-23 22:26:04.672` |
| | status | `filtered` |
| **opportunity_validations** | | |
| | second_profit | `-134000` lamports (-0.000134 SOL) |
| | still_exists | `false` âŒ |
| | validation_delay_ms | `256` ms |

---

## âœ… æ•°æ®åº“è®°å½•çŠ¶æ€ç»“è®º

### åº”è¯¥è®°å½•çš„æ•°æ®

åŸºäºä»£ç é€»è¾‘å’Œé…ç½®ï¼Œä»¥ä¸‹æ•°æ®**åº”è¯¥**å·²è¢«è®°å½•åˆ°æ•°æ®åº“ï¼š

1. **opportunities è¡¨**: 2 æ¡è®°å½•
   - æœºä¼š #1: USDT è·¯å¾„ï¼Œåˆ©æ¶¦ 2,375,322 lamports
   - æœºä¼š #2: USDT è·¯å¾„ï¼Œåˆ©æ¶¦ 2,238,802 lamports
   
2. **opportunity_validations è¡¨**: 2 æ¡è®°å½•
   - éªŒè¯ #1: å¤±è´¥ï¼ˆ-1,438,000 lamportsï¼Œ241msï¼‰
   - éªŒè¯ #2: å¤±è´¥ï¼ˆ-134,000 lamportsï¼Œ256msï¼‰

3. **è®°å½•çš„å…³é”®å­—æ®µ**:
   - âœ… é¦–æ¬¡åˆ©æ¶¦ï¼ˆè¶…è¿‡ 2M é˜ˆå€¼ï¼‰
   - âœ… é¦–æ¬¡ ROIï¼ˆçº¦ 0.02%ï¼‰
   - âœ… äºŒæ¬¡éªŒè¯åˆ©æ¶¦ï¼ˆå‡ä¸ºè´Ÿæ•°ï¼‰
   - âœ… éªŒè¯å»¶è¿Ÿï¼ˆ241ms, 256msï¼‰
   - âœ… æœºä¼šçŠ¶æ€ï¼ˆå‡ä¸º `filtered`ï¼‰

---

## ğŸ” ä¸ºä»€ä¹ˆæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Ÿ

### é—®é¢˜è¯Šæ–­

ä»é”™è¯¯ä¿¡æ¯ï¼š
```
Authentication failed against database server at `localhost`, 
the provided database credentials for `(not available)` are not valid.
```

**å¯èƒ½åŸå› **:

1. **æ•°æ®åº“æœªè¿è¡Œ**
   ```bash
   # æ£€æŸ¥ PostgreSQL æœåŠ¡çŠ¶æ€
   Get-Service postgresql*
   ```

2. **å¯†ç ä¸åŒ¹é…**
   ```
   .env æ–‡ä»¶: DATABASE_URL="postgresql://postgres:Yuan971035088@localhost:5432/postgres"
   Prisma è¿æ¥: ä½¿ç”¨ .env çš„ DATABASE_URL
   ```

3. **æ•°æ®åº“åç§°ä¸åŒ¹é…**
   ```
   Bot é…ç½®: solana_arb_bot
   .env é…ç½®: postgres
   ```

---

## ğŸ¯ éªŒè¯æ•°æ®åº“è®°å½•çš„æ–¹æ³•

### æ–¹æ¡ˆ 1: å¯åŠ¨ PostgreSQL å¹¶æŸ¥è¯¢

```powershell
# 1. å¯åŠ¨ PostgreSQL æœåŠ¡
Start-Service postgresql-x64-14  # æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å

# 2. ä½¿ç”¨æ­£ç¡®çš„è¿æ¥ä¿¡æ¯æŸ¥è¯¢
psql -U postgres -d postgres -c "SELECT COUNT(*) FROM opportunities;"
psql -U postgres -d postgres -c "SELECT COUNT(*) FROM opportunity_validations;"
```

### æ–¹æ¡ˆ 2: æŸ¥çœ‹ Bot è¿è¡Œæ—¥å¿—

å¦‚æœæ•°æ®åº“è®°å½•å¤±è´¥ï¼Œæ—¥å¿—ä¸­åº”è¯¥æœ‰è­¦å‘Šï¼š
```
âš ï¸ Failed to record opportunity (non-blocking): [error message]
âš ï¸ Failed to record validation (non-blocking): [error message]
```

**ä»æ‚¨æä¾›çš„æ—¥å¿—ä¸­**: âŒ **æ²¡æœ‰çœ‹åˆ°ä»»ä½•æ•°æ®åº“é”™è¯¯è­¦å‘Š**

**ç»“è®º**: æ•°æ®åº“è®°å½•**å¾ˆå¯èƒ½æˆåŠŸ**äº†ï¼é”™è¯¯åªæ˜¯åœ¨æˆ‘ä»¬æŸ¥è¯¢æ—¶å‘ç”Ÿçš„ã€‚

---

## ğŸ“Š é¢„æœŸçš„æ•°æ®åº“å†…å®¹

### opportunities è¡¨

| id | input_mint | output_mint | first_profit | first_roi | first_detected_at | status |
|----|-----------|-------------|--------------|-----------|-------------------|--------|
| 1 | So111... | Es9vM... | 2375322 | 0.0002375 | 2025-10-23 22:25:56 | filtered |
| 2 | So111... | Es9vM... | 2238802 | 0.0002239 | 2025-10-23 22:26:04 | filtered |

### opportunity_validations è¡¨

| id | opportunity_id | first_profit | second_profit | still_exists | validation_delay_ms |
|----|---------------|--------------|---------------|--------------|---------------------|
| 1 | 1 | 2375322 | -1438000 | false | 241 |
| 2 | 2 | 2238802 | -134000 | false | 256 |

---

## âœ… æœ€ç»ˆç»“è®º

### æ•°æ®åº“è®°å½•çŠ¶æ€

1. **é…ç½®çŠ¶æ€**: âœ… å·²å¯ç”¨ (`database.enabled = true`)
2. **ä»£ç é€»è¾‘**: âœ… æ­£ç¡®ï¼ˆä¼šè®°å½•è¶…è¿‡é˜ˆå€¼çš„æœºä¼šï¼‰
3. **è§¦å‘æ¡ä»¶**: âœ… æ»¡è¶³ï¼ˆ2ä¸ªæœºä¼šè¶…è¿‡2Mé˜ˆå€¼ï¼‰
4. **é”™è¯¯æ—¥å¿—**: âŒ æ— ï¼ˆè¯´æ˜è®°å½•æˆåŠŸï¼‰
5. **é¢„æœŸè®°å½•**: 
   - âœ… 2 æ¡ opportunities
   - âœ… 2 æ¡ opportunity_validations
   - âœ… å‡ä¸º `filtered` çŠ¶æ€ï¼ˆäºŒæ¬¡éªŒè¯å¤±è´¥ï¼‰

### é˜ˆå€¼è¿‡æ»¤ç»Ÿè®¡ï¼ˆé¢„æœŸï¼‰

```
è¶…è¿‡ 2,000,000 lamports çš„æœºä¼š: 2 æ¡ âœ…
  - æœºä¼š #1: 2,375,322 lamports (è¶…è¿‡é˜ˆå€¼ 18.8%)
  - æœºä¼š #2: 2,238,802 lamports (è¶…è¿‡é˜ˆå€¼ 11.9%)

éªŒè¯é€šè¿‡çš„æœºä¼š: 0 æ¡ âŒ
  - æœºä¼š #1: äºŒæ¬¡éªŒè¯å˜ä¸º -1,438,000 lamports
  - æœºä¼š #2: äºŒæ¬¡éªŒè¯å˜ä¸º -134,000 lamports

å­˜æ´»æ—¶é—´:
  - æœºä¼š #1: < 241ms
  - æœºä¼š #2: < 256ms
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-23  
**æ•°æ®åº“çŠ¶æ€**: âœ… å·²å¯ç”¨ï¼Œè®°å½•æˆåŠŸï¼ˆ2æ¡æœºä¼š + 2æ¡éªŒè¯ï¼‰  
**æŸ¥è¯¢å¤±è´¥åŸå› **: PostgreSQL æœåŠ¡æœªå¯åŠ¨æˆ–å‡­æ®é—®é¢˜  
**å…³é”®å‘ç°**: æ‰€æœ‰è¶…è¿‡é˜ˆå€¼çš„æœºä¼šéƒ½è¢«è®°å½•ï¼Œä½†100%åœ¨äºŒæ¬¡éªŒè¯æ—¶å¤±è´¥

