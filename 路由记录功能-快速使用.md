# 🛣️ 路由记录功能 - 快速使用指南

## ✅ 功能已实现

系统现在**自动记录每个套利机会的完整路由路径**！

---

## 🚀 如何使用

### 1️⃣ 运行 Bot（自动记录路由）

```bash
pnpm run build  # ✅ 已完成
pnpm run flashloan-dryrun
```

Bot 会自动将路由信息存入数据库的 `opportunities.metadata` 字段。

### 2️⃣ 分析路由数据

```bash
# 启动 PostgreSQL（如果未启动）
# 然后运行分析脚本
pnpm tsx analyze-routes.ts
```

**输出示例**:
```
📊 找到 2 条包含元数据的机会记录

1. [filtered] 2025-10-23 22:25:56
   利润: 0.002375 SOL
   总跳数: 2
   去程路由: Orca (SOL → USDT)
   返程路由: Raydium (USDT → SOL)
   使用的 DEX: Orca, Raydium

📊 DEX 使用统计:
   Orca: 2 次 (100.0%)
   Raydium: 2 次 (100.0%)
```

---

## 📊 记录的信息

每个机会记录包含：

### ✅ 路由信息
- 去程路径（SOL → 桥接代币）
- 返程路径（桥接代币 → SOL）
- 每一跳使用的 DEX
- 每一跳的输入/输出金额
- 总跳数

### ✅ 桥接代币信息
- 代币符号（USDC/USDT/JUP等）
- 代币 Mint 地址
- 桥接金额

### ✅ 利润分析
- 预期利润（lamports）
- ROI（投资回报率）
- 输入/输出金额
- 查询耗时

---

## 🎯 应用场景

### 分析哪些 DEX 最好用
```bash
pnpm tsx analyze-routes.ts
# 查看 "DEX 使用统计" 部分
```

### 分析最佳路由跳数
```bash
pnpm tsx analyze-routes.ts
# 查看 "按跳数的平均利润" 部分
```

### 优化桥接代币选择
- 运行 Bot 一段时间（如30分钟）
- 运行分析脚本
- 根据利润数据调整 `bridge-tokens.json`

---

## 📝 数据库查询示例

```sql
-- 查看最新的路由记录
SELECT 
  id,
  first_detected_at,
  first_profit / 1e9 as profit_sol,
  bridge_token,
  metadata->'routeInfo'->>'totalHops' as hops,
  metadata->'routeInfo'->>'dexes' as dexes
FROM opportunities
WHERE metadata IS NOT NULL
ORDER BY first_detected_at DESC
LIMIT 10;
```

---

## ⚙️ 数据结构

路由信息存储在 JSON 格式的 `metadata` 字段：

```json
{
  "routeInfo": {
    "totalHops": 2,
    "dexes": ["Orca", "Raydium"],
    "outboundRoute": [{
      "stepNumber": 1,
      "dex": "Orca",
      "inputMint": "So111...",
      "outputMint": "EPjFW..."
    }],
    "returnRoute": [...]
  },
  "bridgeInfo": {
    "symbol": "USDC",
    "mint": "EPjFWdd5Au...",
    "amount": "1894295485"
  },
  "profitAnalysis": {
    "expectedProfit": 2375322,
    "roi": 0.0002375
  }
}
```

---

## 🔍 常见问题

### Q: 如何确认路由正在记录？

A: 查看 Bot 日志，应该看到：
```
📝 Recorded opportunity #1 with route metadata
```

### Q: 数据库没有路由数据？

A: 检查：
1. PostgreSQL 是否运行
2. `configs/flashloan-dryrun.toml` 中 `database.enabled = true`
3. `.env` 文件中的 `DATABASE_URL` 是否正确

### Q: 如何清理旧数据？

A: 
```sql
DELETE FROM opportunities
WHERE first_detected_at < NOW() - INTERVAL '30 days';
```

---

## 📚 完整文档

详细信息请参考：`路由记录功能说明.md`

---

**状态**: ✅ 已实现，已编译成功  
**下一步**: 运行 Bot 并观察路由记录！

