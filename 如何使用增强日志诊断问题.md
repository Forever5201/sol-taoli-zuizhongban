# 🔍 如何使用增强日志诊断查询执行问题

## 📋 快速开始

### 1️⃣ 运行 Bot

```bash
# 已编译完成，直接运行
pnpm run flashloan-dryrun
```

### 2️⃣ 等待首次统计（约 1-2 分钟）

Bot 会在第 10 轮扫描后输出第一次统计。

---

## 📊 如何读懂新增的日志

### 完整日志示例

```
[Worker 0] 📊 ═══════════════ Latency Statistics (Last 100 queries) ═══════════════
[Worker 0] 📊 Outbound (SOL→Bridge): avg 189ms, min 104ms, max 684ms
[Worker 0] 📊 Return (Bridge→SOL):   avg 193ms, min 102ms, max 570ms
[Worker 0] 📊 Total per round:       avg 191ms (7100 rounds, 288 queries)

✅ 新增部分开始
[Worker 0] 📊 Success Rate:          95.1% (274/288)     ← 成功率
[Worker 0] 📊 Failure Rate:          2.4% (7/288)        ← 失败率
[Worker 0] 📊 No Route Rate:         2.5% (7/288)        ← 无路由率

[Worker 0] 📊 Error Breakdown:                           ← 错误详情
[Worker 0] 📊   TIMEOUT: 3 (1.0%)                        ← 超时次数
[Worker 0] 📊   NO_ROUTE: 7 (2.4%)                       ← 无路由次数
[Worker 0] 📊   API_ERROR: 4 (1.4%)                      ← API错误次数

[Worker 0] 📊 Bridge Token Performance:                  ← 桥接代币表现
[Worker 0] 📊   USDC: 150 queries, 98.0% success, 1.3% no-route, 2 opps, avg 180ms
                      ↑ 查询数   ↑ 成功率     ↑ 无路由率  ↑ 机会数 ↑ 平均延迟
[Worker 0] 📊   USDT: 138 queries, 92.0% success, 5.1% no-route, 1 opps, avg 202ms

[Worker 0] 📊 Opportunities found:   3
[Worker 0] 📊 ═══════════════════════════════════════════════════════════════════════════
```

---

## 🎯 诊断场景

### 场景 1: 成功率极低（< 10%）🔴

```
[Worker 1] 📊 Success Rate:          3.2% (7/216)
[Worker 1] 📊 No Route Rate:         96.8% (209/216)
[Worker 1] 📊 Bridge Token Performance:
[Worker 1] 📊   JUP: 108 queries, 0.9% success, 99.1% no-route, 0 opps
[Worker 1] 📊   RAY: 108 queries, 5.6% success, 94.4% no-route, 0 opps
```

**问题诊断**: JUP/RAY 桥接代币流动性极差，99% 的查询找不到路由。

**解决方案**: 移除 JUP/RAY，只保留 USDC/USDT
```bash
# 编辑 bridge-tokens.json
# 将 JUP 和 RAY 的 enabled 改为 false
```

---

### 场景 2: 超时率高（> 50%）🔴

```
[Worker 0] 📊 Success Rate:          15.3% (44/288)
[Worker 0] 📊 Failure Rate:          84.7% (244/288)
[Worker 0] 📊 Error Breakdown:
[Worker 0] 📊   TIMEOUT: 244 (84.7%)
```

**问题诊断**: 网络太慢或代理响应慢，84.7% 的查询超时。

**解决方案**: 增加超时时间
```typescript
// packages/jupiter-bot/src/workers/query-worker.ts
// 找到 axiosConfig.timeout，从 3000 改为 5000
axiosConfig.timeout = 5000;  // 增加至 5 秒
```

---

### 场景 3: API 错误率高（> 30%）🔴

```
[Worker 0] 📊 Success Rate:          25.0% (72/288)
[Worker 0] 📊 Failure Rate:          75.0% (216/288)
[Worker 0] 📊 Error Breakdown:
[Worker 0] 📊   API_ERROR: 216 (75.0%)
```

**同时查看实时日志**:
```
[Worker 0] ❌ API Error 429: So111111...→USDC
[Worker 0] ❌ API Error 429: So111111...→USDT
```

**问题诊断**: 触发 Jupiter API 速率限制（429 错误）。

**解决方案**: 降低查询频率
```toml
# configs/flashloan-dryrun.toml
query_interval_ms = 150  # 从 80ms 增加到 150ms
```

---

### 场景 4: 网络错误率高（> 30%）🔴

```
[Worker 0] 📊 Success Rate:          20.5% (59/288)
[Worker 0] 📊 Failure Rate:          79.5% (229/288)
[Worker 0] 📊 Error Breakdown:
[Worker 0] 📊   NETWORK_ERROR: 229 (79.5%)
```

**同时查看实时日志**:
```
[Worker 0] 🌐 Network Error: So111111...→USDC
[Worker 0] 🌐 Network Error: So111111...→USDT
```

**问题诊断**: 代理连接不稳定（ECONNRESET 错误）。

**解决方案**: 
1. 检查代理是否正常运行
2. 更换代理服务器
3. 启用连接重试机制

---

### 场景 5: 成功率良好（> 80%）✅

```
[Worker 0] 📊 Success Rate:          95.1% (274/288)
[Worker 0] 📊 Failure Rate:          2.4% (7/288)
[Worker 0] 📊 No Route Rate:         2.5% (7/288)
[Worker 0] 📊 Bridge Token Performance:
[Worker 0] 📊   USDC: 150 queries, 98.0% success, 1.3% no-route, 2 opps, avg 180ms
[Worker 0] 📊   USDT: 138 queries, 92.0% success, 5.1% no-route, 1 opps, avg 202ms
```

**问题诊断**: 系统运行正常！之前的 0.9% 执行率是因为日志不够详细，无法看到大量的"无路由"响应。

**结论**: 无需修改，系统工作正常。

---

## 🔍 实时错误日志

除了每 10 轮的统计摘要，系统还会实时输出每个错误：

### 超时错误
```
[Worker 0] ⏱️ Timeout: So111111...→JUP (3021ms)
```
**含义**: 查询 SOL→JUP 超时，耗时 3021ms。

### API 错误
```
[Worker 0] ❌ API Error 429: So111111...→USDC
```
**含义**: Jupiter API 返回 429（速率限制）错误。

### 无路由
```
[Worker 0] ⚠️ No route found: So111111...→JUP
```
**含义**: Jupiter 找不到 SOL→JUP 的交易路径（流动性不足）。

### 网络错误
```
[Worker 0] 🌐 Network Error: So111111...→USDT
```
**含义**: 网络连接问题（通常是代理断开）。

---

## 📈 查询进度日志

每 100 次查询会输出进度：

```
[Worker 0] 🔍 Query #100: So111111...→USDC
[Worker 0] 🔍 Query #200: So111111...→USDT
[Worker 0] 🔍 Query #300: So111111...→USDC
```

**用途**: 确认 Worker 仍在工作，没有卡死。

---

## 🎯 解决 0.9% 执行率问题的步骤

### 步骤 1: 运行 Bot 并等待统计

```bash
pnpm run flashloan-dryrun
# 等待约 2 分钟，直到看到第一次统计输出
```

### 步骤 2: 查看成功率

**如果成功率 > 80%**:
- ✅ 系统正常！之前的 0.9% 是误解。
- 实际上每轮都在查询，只是大部分返回"无路由"。

**如果成功率 < 10%**:
- 🔴 有问题！继续步骤 3。

### 步骤 3: 查看错误详情

**如果 NO_ROUTE > 80%**:
- 桥接代币流动性差
- 移除低效代币（JUP/RAY）

**如果 TIMEOUT > 50%**:
- 网络太慢
- 增加 timeout 配置

**如果 API_ERROR > 30%**:
- 速率限制
- 降低查询频率

**如果 NETWORK_ERROR > 30%**:
- 代理问题
- 检查/更换代理

### 步骤 4: 应用修复并重新测试

根据诊断结果修改配置，然后：
```bash
pnpm run build  # 如果修改了 TypeScript 代码
pnpm run flashloan-dryrun  # 重新运行
```

---

## 📊 预期结果

### 正常情况

```
每轮扫描: 2 桥接代币 × 2 方向 = 4 次查询
成功率: 80-95%
每 10 轮: 40 次查询，32-38 次成功
```

### 异常情况（当前）

```
每轮扫描: 应该 4 次查询
实际统计: 288 queries / 7100 rounds = 0.04 queries/round
问题: 99% 的查询被静默跳过或失败
```

**新日志会准确显示为什么！**

---

## ✅ 总结

### 新增功能

1. ✅ **成功率统计** - 知道有多少查询真正成功
2. ✅ **错误分类** - 知道失败原因（超时/无路由/API错误）
3. ✅ **桥接代币性能** - 知道哪些代币有效
4. ✅ **实时错误日志** - 每个错误都有详细记录

### 立即开始

```bash
pnpm run flashloan-dryrun
```

2 分钟后，您将准确知道为什么查询执行率只有 0.9%！🔍

---

**创建时间**: 2025-10-23  
**状态**: ✅ 可以立即使用  
**预期诊断时间**: 2 分钟

