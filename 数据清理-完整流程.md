# 数据清理 + 完整记录 - 操作流程

## 🎯 目标

删除所有旧数据（没有完整延迟记录的），重新开始记录包含所有延迟字段的完整数据。

---

## 📋 完整操作流程

### 第一步：清空旧数据

#### 方式1：使用批处理脚本（推荐）
```bash
.\clear-old-data.bat
```

**提示**：
- 会要求输入 `YES` 确认
- 自动连接数据库并清空数据
- 保留表结构，重置ID序列

#### 方式2：手动执行SQL
```bash
# 登录数据库
psql -h localhost -U solana_arb_user -d solana_arb_bot

# 执行清理SQL
\i clear-old-data.sql

# 或者直接粘贴SQL内容
```

---

### 第二步：执行数据库迁移（添加新字段）

#### 方式1：Prisma Migrate（推荐）
```bash
cd packages/core
pnpm prisma migrate dev --name add_latency_tracking_fields
```

#### 方式2：手动SQL
```bash
psql -h localhost -U solana_arb_user -d solana_arb_bot
\i 数据记录完整性修复-迁移SQL.sql
```

---

### 第三步：验证配置

```bash
.\verify-latency-tracking.bat
```

**预期输出**：
```
✅ 数据库连接成功
✅ TypeScript类型已验证
⚠️ 暂无验证记录（正常，Bot启动后会记录）
总验证记录: 0
```

---

### 第四步：重启Bot

```bash
.\start-flashloan-dryrun.bat
```

**观察日志**：
- ✅ Worker输出延迟统计（outbound/return）
- ✅ 发现机会时显示完整信息
- ✅ 二次验证显示详细延迟

---

### 第五步：等待数据积累（30分钟）

让Bot运行30分钟，然后查看数据质量：

```bash
.\verify-latency-tracking.bat
```

**预期输出**：
```
✅ 找到 X 条验证记录
   记录 1:
      第一次 outbound: 245ms  ← 应该有值
      第一次 return: 198ms    ← 应该有值
      第二次 outbound: 187ms  ← 应该有值
      第二次 return: 165ms    ← 应该有值
```

---

## 🗄️ 清理的数据表

| 表名 | 作用 | 清理后 |
|------|------|--------|
| `opportunities` | 机会记录 | 0条记录，ID从1开始 |
| `opportunity_validations` | 验证记录 | 0条记录，ID从1开始 |
| `trade_routes` | 交易路由 | 0条记录，ID从1开始 |
| `flash_loan_transactions` | 交易记录 | 0条记录，ID从1开始 |

**保留的内容**：
- ✅ 表结构
- ✅ 索引
- ✅ 外键约束
- ✅ 字段定义

---

## 🔍 验证清理成功

### SQL查询确认
```sql
-- 检查所有表的记录数
SELECT 
    'opportunities' AS table_name,
    COUNT(*) AS record_count
FROM opportunities
UNION ALL
SELECT 'opportunity_validations', COUNT(*) FROM opportunity_validations
UNION ALL
SELECT 'trade_routes', COUNT(*) FROM trade_routes
UNION ALL
SELECT 'flash_loan_transactions', COUNT(*) FROM flash_loan_transactions;

-- 预期输出：所有表都是 0
```

### 检查Schema字段
```sql
-- 确认新字段已添加
SELECT column_name, data_type 
FROM information_schema.columns
WHERE table_name = 'opportunity_validations'
    AND column_name LIKE '%_ms';

-- 预期输出：
-- validation_delay_ms
-- first_outbound_ms   ← 新增
-- first_return_ms     ← 新增
-- second_outbound_ms  ← 新增
-- second_return_ms    ← 新增
```

---

## ⚠️ 重要提醒

### 清理前
- [ ] 确认不需要旧数据（或已备份）
- [ ] 确认Bot已停止运行
- [ ] 检查数据库连接正常

### 清理后
- [ ] 执行数据库迁移（添加4个新字段）
- [ ] 运行验证脚本确认Schema正确
- [ ] 重新编译代码：`pnpm run build`（已完成✅）
- [ ] 重启Bot开始记录新数据

---

## 📊 新数据的优势

清理后重新记录的数据将包含：

| 数据点 | 旧数据 | 新数据 |
|--------|--------|--------|
| RPC过滤原因 | ❌ 缺失 | ✅ 详细记录 |
| 第一次outbound延迟 | ❌ 仅日志 | ✅ 数据库 |
| 第一次return延迟 | ❌ 仅日志 | ✅ 数据库 |
| 第二次outbound延迟 | ❌ 缺失 | ✅ 数据库 |
| 第二次return延迟 | ❌ 缺失 | ✅ 数据库 |

**分析能力提升**：
- 🎯 可以对比Ultra API vs Lite API性能
- 🎯 可以分析延迟与机会存活的关系
- 🎯 可以识别网络/代理瓶颈
- 🎯 可以优化查询频率和Worker配置

---

## 🚀 快速命令总结

```bash
# 1. 清空旧数据
.\clear-old-data.bat

# 2. 迁移数据库（添加新字段）
cd packages/core
pnpm prisma migrate dev --name add_latency_tracking_fields
cd ../..

# 3. 验证配置
.\verify-latency-tracking.bat

# 4. 重启Bot
.\start-flashloan-dryrun.bat

# 5. 等待30分钟后，再次验证
.\verify-latency-tracking.bat
```

---

## 📞 问题排查

### 问题1：psql命令找不到

**解决**：
```bash
# 使用pgAdmin或其他PostgreSQL客户端
# 手动执行 clear-old-data.sql 文件内容
```

### 问题2：权限不足

**解决**：
```sql
-- 使用超级用户登录
psql -h localhost -U postgres -d solana_arb_bot
-- 然后执行清理SQL
```

### 问题3：外键约束错误

**解决**：SQL已使用`TRUNCATE ... CASCADE`，会自动处理外键

---

**准备好了吗？执行 `.\clear-old-data.bat` 开始清理！** 🚀

