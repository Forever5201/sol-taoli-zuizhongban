# æ•°æ®æ¸…ç† + å®Œæ•´è®°å½• - æ“ä½œæµç¨‹

## ğŸ¯ ç›®æ ‡

åˆ é™¤æ‰€æœ‰æ—§æ•°æ®ï¼ˆæ²¡æœ‰å®Œæ•´å»¶è¿Ÿè®°å½•çš„ï¼‰ï¼Œé‡æ–°å¼€å§‹è®°å½•åŒ…å«æ‰€æœ‰å»¶è¿Ÿå­—æ®µçš„å®Œæ•´æ•°æ®ã€‚

---

## ğŸ“‹ å®Œæ•´æ“ä½œæµç¨‹

### ç¬¬ä¸€æ­¥ï¼šæ¸…ç©ºæ—§æ•°æ®

#### æ–¹å¼1ï¼šä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
.\clear-old-data.bat
```

**æç¤º**ï¼š
- ä¼šè¦æ±‚è¾“å…¥ `YES` ç¡®è®¤
- è‡ªåŠ¨è¿æ¥æ•°æ®åº“å¹¶æ¸…ç©ºæ•°æ®
- ä¿ç•™è¡¨ç»“æ„ï¼Œé‡ç½®IDåºåˆ—

#### æ–¹å¼2ï¼šæ‰‹åŠ¨æ‰§è¡ŒSQL
```bash
# ç™»å½•æ•°æ®åº“
psql -h localhost -U solana_arb_user -d solana_arb_bot

# æ‰§è¡Œæ¸…ç†SQL
\i clear-old-data.sql

# æˆ–è€…ç›´æ¥ç²˜è´´SQLå†…å®¹
```

---

### ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆæ·»åŠ æ–°å­—æ®µï¼‰

#### æ–¹å¼1ï¼šPrisma Migrateï¼ˆæ¨èï¼‰
```bash
cd packages/core
pnpm prisma migrate dev --name add_latency_tracking_fields
```

#### æ–¹å¼2ï¼šæ‰‹åŠ¨SQL
```bash
psql -h localhost -U solana_arb_user -d solana_arb_bot
\i æ•°æ®è®°å½•å®Œæ•´æ€§ä¿®å¤-è¿ç§»SQL.sql
```

---

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯é…ç½®

```bash
.\verify-latency-tracking.bat
```

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
âœ… TypeScriptç±»å‹å·²éªŒè¯
âš ï¸ æš‚æ— éªŒè¯è®°å½•ï¼ˆæ­£å¸¸ï¼ŒBotå¯åŠ¨åä¼šè®°å½•ï¼‰
æ€»éªŒè¯è®°å½•: 0
```

---

### ç¬¬å››æ­¥ï¼šé‡å¯Bot

```bash
.\start-flashloan-dryrun.bat
```

**è§‚å¯Ÿæ—¥å¿—**ï¼š
- âœ… Workerè¾“å‡ºå»¶è¿Ÿç»Ÿè®¡ï¼ˆoutbound/returnï¼‰
- âœ… å‘ç°æœºä¼šæ—¶æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
- âœ… äºŒæ¬¡éªŒè¯æ˜¾ç¤ºè¯¦ç»†å»¶è¿Ÿ

---

### ç¬¬äº”æ­¥ï¼šç­‰å¾…æ•°æ®ç§¯ç´¯ï¼ˆ30åˆ†é’Ÿï¼‰

è®©Botè¿è¡Œ30åˆ†é’Ÿï¼Œç„¶åæŸ¥çœ‹æ•°æ®è´¨é‡ï¼š

```bash
.\verify-latency-tracking.bat
```

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ… æ‰¾åˆ° X æ¡éªŒè¯è®°å½•
   è®°å½• 1:
      ç¬¬ä¸€æ¬¡ outbound: 245ms  â† åº”è¯¥æœ‰å€¼
      ç¬¬ä¸€æ¬¡ return: 198ms    â† åº”è¯¥æœ‰å€¼
      ç¬¬äºŒæ¬¡ outbound: 187ms  â† åº”è¯¥æœ‰å€¼
      ç¬¬äºŒæ¬¡ return: 165ms    â† åº”è¯¥æœ‰å€¼
```

---

## ğŸ—„ï¸ æ¸…ç†çš„æ•°æ®è¡¨

| è¡¨å | ä½œç”¨ | æ¸…ç†å |
|------|------|--------|
| `opportunities` | æœºä¼šè®°å½• | 0æ¡è®°å½•ï¼ŒIDä»1å¼€å§‹ |
| `opportunity_validations` | éªŒè¯è®°å½• | 0æ¡è®°å½•ï¼ŒIDä»1å¼€å§‹ |
| `trade_routes` | äº¤æ˜“è·¯ç”± | 0æ¡è®°å½•ï¼ŒIDä»1å¼€å§‹ |
| `flash_loan_transactions` | äº¤æ˜“è®°å½• | 0æ¡è®°å½•ï¼ŒIDä»1å¼€å§‹ |

**ä¿ç•™çš„å†…å®¹**ï¼š
- âœ… è¡¨ç»“æ„
- âœ… ç´¢å¼•
- âœ… å¤–é”®çº¦æŸ
- âœ… å­—æ®µå®šä¹‰

---

## ğŸ” éªŒè¯æ¸…ç†æˆåŠŸ

### SQLæŸ¥è¯¢ç¡®è®¤
```sql
-- æ£€æŸ¥æ‰€æœ‰è¡¨çš„è®°å½•æ•°
SELECT 
    'opportunities' AS table_name,
    COUNT(*) AS record_count
FROM opportunities
UNION ALL
SELECT 'opportunity_validations', COUNT(*) FROM opportunity_validations
UNION ALL
SELECT 'trade_routes', COUNT(*) FROM trade_routes
UNION ALL
SELECT 'flash_loan_transactions', COUNT(*) FROM flash_loan_transactions;

-- é¢„æœŸè¾“å‡ºï¼šæ‰€æœ‰è¡¨éƒ½æ˜¯ 0
```

### æ£€æŸ¥Schemaå­—æ®µ
```sql
-- ç¡®è®¤æ–°å­—æ®µå·²æ·»åŠ 
SELECT column_name, data_type 
FROM information_schema.columns
WHERE table_name = 'opportunity_validations'
    AND column_name LIKE '%_ms';

-- é¢„æœŸè¾“å‡ºï¼š
-- validation_delay_ms
-- first_outbound_ms   â† æ–°å¢
-- first_return_ms     â† æ–°å¢
-- second_outbound_ms  â† æ–°å¢
-- second_return_ms    â† æ–°å¢
```

---

## âš ï¸ é‡è¦æé†’

### æ¸…ç†å‰
- [ ] ç¡®è®¤ä¸éœ€è¦æ—§æ•°æ®ï¼ˆæˆ–å·²å¤‡ä»½ï¼‰
- [ ] ç¡®è®¤Botå·²åœæ­¢è¿è¡Œ
- [ ] æ£€æŸ¥æ•°æ®åº“è¿æ¥æ­£å¸¸

### æ¸…ç†å
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆæ·»åŠ 4ä¸ªæ–°å­—æ®µï¼‰
- [ ] è¿è¡ŒéªŒè¯è„šæœ¬ç¡®è®¤Schemaæ­£ç¡®
- [ ] é‡æ–°ç¼–è¯‘ä»£ç ï¼š`pnpm run build`ï¼ˆå·²å®Œæˆâœ…ï¼‰
- [ ] é‡å¯Botå¼€å§‹è®°å½•æ–°æ•°æ®

---

## ğŸ“Š æ–°æ•°æ®çš„ä¼˜åŠ¿

æ¸…ç†åé‡æ–°è®°å½•çš„æ•°æ®å°†åŒ…å«ï¼š

| æ•°æ®ç‚¹ | æ—§æ•°æ® | æ–°æ•°æ® |
|--------|--------|--------|
| RPCè¿‡æ»¤åŸå›  | âŒ ç¼ºå¤± | âœ… è¯¦ç»†è®°å½• |
| ç¬¬ä¸€æ¬¡outboundå»¶è¿Ÿ | âŒ ä»…æ—¥å¿— | âœ… æ•°æ®åº“ |
| ç¬¬ä¸€æ¬¡returnå»¶è¿Ÿ | âŒ ä»…æ—¥å¿— | âœ… æ•°æ®åº“ |
| ç¬¬äºŒæ¬¡outboundå»¶è¿Ÿ | âŒ ç¼ºå¤± | âœ… æ•°æ®åº“ |
| ç¬¬äºŒæ¬¡returnå»¶è¿Ÿ | âŒ ç¼ºå¤± | âœ… æ•°æ®åº“ |

**åˆ†æèƒ½åŠ›æå‡**ï¼š
- ğŸ¯ å¯ä»¥å¯¹æ¯”Ultra API vs Lite APIæ€§èƒ½
- ğŸ¯ å¯ä»¥åˆ†æå»¶è¿Ÿä¸æœºä¼šå­˜æ´»çš„å…³ç³»
- ğŸ¯ å¯ä»¥è¯†åˆ«ç½‘ç»œ/ä»£ç†ç“¶é¢ˆ
- ğŸ¯ å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢é¢‘ç‡å’ŒWorkeré…ç½®

---

## ğŸš€ å¿«é€Ÿå‘½ä»¤æ€»ç»“

```bash
# 1. æ¸…ç©ºæ—§æ•°æ®
.\clear-old-data.bat

# 2. è¿ç§»æ•°æ®åº“ï¼ˆæ·»åŠ æ–°å­—æ®µï¼‰
cd packages/core
pnpm prisma migrate dev --name add_latency_tracking_fields
cd ../..

# 3. éªŒè¯é…ç½®
.\verify-latency-tracking.bat

# 4. é‡å¯Bot
.\start-flashloan-dryrun.bat

# 5. ç­‰å¾…30åˆ†é’Ÿåï¼Œå†æ¬¡éªŒè¯
.\verify-latency-tracking.bat
```

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼špsqlå‘½ä»¤æ‰¾ä¸åˆ°

**è§£å†³**ï¼š
```bash
# ä½¿ç”¨pgAdminæˆ–å…¶ä»–PostgreSQLå®¢æˆ·ç«¯
# æ‰‹åŠ¨æ‰§è¡Œ clear-old-data.sql æ–‡ä»¶å†…å®¹
```

### é—®é¢˜2ï¼šæƒé™ä¸è¶³

**è§£å†³**ï¼š
```sql
-- ä½¿ç”¨è¶…çº§ç”¨æˆ·ç™»å½•
psql -h localhost -U postgres -d solana_arb_bot
-- ç„¶åæ‰§è¡Œæ¸…ç†SQL
```

### é—®é¢˜3ï¼šå¤–é”®çº¦æŸé”™è¯¯

**è§£å†³**ï¼šSQLå·²ä½¿ç”¨`TRUNCATE ... CASCADE`ï¼Œä¼šè‡ªåŠ¨å¤„ç†å¤–é”®

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿæ‰§è¡Œ `.\clear-old-data.bat` å¼€å§‹æ¸…ç†ï¼** ğŸš€

